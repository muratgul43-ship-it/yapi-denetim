<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yapı Denetim İş Takip Sistemi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --primary-light: #818CF8;
            --success: #059669;
            --success-light: #34D399;
            --warning: #D97706;
            --warning-light: #FBBF24;
            --danger: #DC2626;
            --danger-light: #F87171;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Açık tema renkleri */
            --bg-primary: #ffffff;
            --bg-secondary: #F9FAFB;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --card-bg: #ffffff;
        }
        
        [data-theme="dark"] {
            --gray-50: #1F2937;
            --gray-100: #374151;
            --gray-200: #4B5563;
            --gray-300: #6B7280;
            --gray-400: #9CA3AF;
            --gray-500: #D1D5DB;
            --gray-600: #E5E7EB;
            --gray-700: #F3F4F6;
            --gray-800: #F9FAFB;
            --gray-900: #FFFFFF;
            
            /* Koyu tema renkleri */
            --bg-primary: #111827;
            --bg-secondary: #1F2937;
            --bg-gradient: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
            --text-primary: #F9FAFB;
            --text-secondary: #D1D5DB;
            --border-color: #374151;
            --card-bg: #1F2937;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.4), 0 1px 2px -1px rgb(0 0 0 / 0.4);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5), 0 4px 6px -4px rgb(0 0 0 / 0.5);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.5), 0 8px 10px -6px rgb(0 0 0 / 0.5);
        }
        
        /* Koyu tema için genel overrides */
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] .tablo,
        [data-theme="dark"] table,
        [data-theme="dark"] .btn,
        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background: var(--card-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] td,
        [data-theme="dark"] th {
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .modal-overlay {
            background: rgba(0, 0, 0, 0.8) !important;
        }
        
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .firma-card {
            background: var(--card-bg) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .firma-item {
            background: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .firma-item:hover {
            background: var(--gray-100) !important;
        }
        
        [data-theme="dark"] .seviye-onayli {
            background: linear-gradient(135deg, #1E3A8A 0%, #1E40AF 100%) !important;
            color: #BFDBFE !important;
        }
        
        [data-theme="dark"] .seviye-reel {
            background: linear-gradient(135deg, #78350F 0%, #92400E 100%) !important;
            color: #FED7AA !important;
        }
        
        [data-theme="dark"] .hizmet-bedeli {
            color: #6EE7B7 !important;
        }
        
        [data-theme="dark"] .sozlesme-bedeli {
            color: #93C5FD !important;
        }
        
        /* Koyu tema için inline style override'lar */
        [data-theme="dark"] div[style*="background: white"],
        [data-theme="dark"] div[style*="background: 'white'"],
        [data-theme="dark"] div[style*='background: "white"'] {
            background: var(--card-bg) !important;
        }
        
        [data-theme="dark"] div[style*="color: 'var(--gray-600')"],
        [data-theme="dark"] div[style*="color: var(--gray-600)"],
        [data-theme="dark"] span[style*="color: 'var(--gray-600')"],
        [data-theme="dark"] span[style*="color: var(--gray-600)"],
        [data-theme="dark"] p[style*="color: 'var(--gray-600')"],
        [data-theme="dark"] p[style*="color: var(--gray-600)"] {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3,
        [data-theme="dark"] h4 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .ozet-kart {
            background: var(--card-bg) !important;
        }
        
        [data-theme="dark"] .ozet-deger {
            color: inherit !important;
            filter: brightness(1.3);
        }
        
        [data-theme="dark"] .ozet-label {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .sayfa-baslik {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .sayfa-aciklama {
            color: var(--text-secondary) !important;
        }
        
        .filtre-toggle-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .filtre-toggle-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-50%) scale(1.05);
        }
        
        .filtre-toggle-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .filtre-badge {
            color: #FCD34D;
            font-size: 20px;
            line-height: 1;
            margin-left: -4px;
        }
        
        .filtre-panel {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
        }
        
        .arama-container {
            position: relative;
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.5;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* Firma Seçim Ekranı */
        .firma-secim {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3a5f 0%, #0f2744 50%, #0a1929 100%);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .firma-secim::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(79, 70, 229, 0.1) 0%, transparent 50%);
            animation: pulse 15s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .firma-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 48px 56px;
            max-width: 520px;
            width: 100%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 1;
            backdrop-filter: blur(10px);
        }
        
        .firma-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .firma-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            box-shadow: 0 10px 30px -10px rgba(79, 70, 229, 0.5);
        }
        
        .firma-logo svg {
            width: 44px;
            height: 44px;
            color: white;
        }
        
        .firma-title {
            font-size: 26px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .firma-subtitle {
            font-size: 15px;
            color: var(--gray-500);
            font-weight: 400;
        }
        
        .firma-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .firma-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 24px;
            border: 2px solid transparent;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .firma-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .firma-btn:hover::before {
            opacity: 1;
        }
        
        .firma-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px -10px currentColor;
        }
        
        .firma-btn-icon {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .firma-btn-text {
            flex: 1;
            text-align: left;
        }
        
        .firma-btn-arrow {
            width: 24px;
            height: 24px;
            opacity: 0.7;
        }
        
        /* Header */
        .header {
            background: var(--card-bg);
            padding: 0 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
            height: 72px;
            transition: background 0.3s ease;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .theme-toggle {
            width: 44px;
            height: 44px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            background: var(--gray-100);
            border-color: var(--primary);
            transform: scale(1.05);
        }
        
        .theme-toggle svg {
            width: 22px;
            height: 22px;
            color: var(--text-secondary);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px -2px rgba(79, 70, 229, 0.4);
        }
        
        .logo-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }
        
        .logo-text {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.5px;
        }
        
        .firma-select {
            padding: 10px 36px 10px 16px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            background: var(--card-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 12px center;
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            color: var(--text-primary);
        }
        
        .firma-select:hover {
            border-color: var(--gray-300);
        }
        
        .firma-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .nav {
            display: flex;
            gap: 6px;
            background: var(--gray-100);
            padding: 6px;
            border-radius: 12px;
        }
        
        .nav-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-btn:hover {
            background: white;
            color: var(--gray-900);
        }
        
        .nav-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        
        .nav-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* Main */
        .main {
            padding: 28px 32px;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* Özet Kartları */
        .ozet-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }
        
        .ozet-kart {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .ozet-kart:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .ozet-kart::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }
        
        .ozet-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            font-size: 22px;
        }
        
        .ozet-baslik {
            font-size: 13px;
            color: var(--gray-500);
            font-weight: 500;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .ozet-deger {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.5px;
        }
        
        .ozet-deger.small {
            font-size: 20px;
        }
        
        /* Aksiyon Bar */
        .aksiyon-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .buton-container {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }
        
        .btn svg {
            width: 18px;
            height: 18px;
        }
        
        .btn-ekle {
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
        }
        
        .btn-ekle:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -8px rgba(5, 150, 105, 0.6);
        }
        
        .btn-guncelle {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .btn-guncelle:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -8px rgba(79, 70, 229, 0.6);
        }
        
        .btn-sil {
            background: linear-gradient(135deg, var(--danger) 0%, #B91C1C 100%);
            color: white;
        }
        
        .btn-sil:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -8px rgba(220, 38, 38, 0.6);
        }
        
        .btn-excel {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }
        
        .btn-excel:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -8px rgba(5, 150, 105, 0.6);
        }
        
        .btn-pdf {
            background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
            color: white;
        }
        
        .btn-pdf:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -8px rgba(220, 38, 38, 0.6);
        }
        
        .btn-print {
            background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%);
            color: white;
        }
        
        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -8px rgba(124, 58, 237, 0.6);
        }
        
        /* Yazdırma için stil */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media print {
            body {
                background: white !important;
            }
            
            .header,
            .nav,
            .btn,
            .arama-container,
            .filtre-panel,
            .modal-overlay,
            .theme-toggle,
            .ozet-container,
            .sayfa-header,
            .uyari-container,
            .aksiyonlar {
                display: none !important;
            }
            
            .main {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .tablo-container {
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
            }
            
            .tablo-scroll {
                overflow: visible !important;
            }
            
            .tablo {
                border: 1px solid #000;
                font-size: 8px !important;
                width: 100%;
                table-layout: fixed;
                border-collapse: collapse;
            }
            
            .tablo th,
            .tablo td {
                border: 1px solid #000;
                padding: 2px 3px !important;
                color: #000 !important;
                background: white !important;
                font-size: 8px !important;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .tablo th {
                background: #f0f0f0 !important;
                font-weight: bold;
                font-size: 8px !important;
            }
            
            .seviye-onayli,
            .seviye-reel {
                color: #000 !important;
                font-weight: bold;
                background: #f0f0f0 !important;
                font-size: 8px !important;
            }
            
            .badge {
                border: 1px solid #000 !important;
                background: white !important;
                color: #000 !important;
                padding: 1px 3px !important;
                font-size: 7px !important;
            }
            
            /* YBİF No kolonunu biraz dar tut */
            .tablo td:first-child,
            .tablo th:first-child {
                width: 60px;
            }
            
            @page {
                margin: 0.5cm;
                size: A4 landscape;
            }
        }
        
        /* Arama */
        .arama-container {
            position: relative;
            flex: 1;
            max-width: 400px;
        }
        
        .arama-input {
            width: 100%;
            padding: 12px 16px 12px 48px;
            font-size: 14px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            background: white;
            outline: none;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .arama-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .arama-input::placeholder {
            color: var(--gray-400);
        }
        
        .arama-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }
        
        .arama-icon svg {
            width: 20px;
            height: 20px;
        }
        
        /* Tablo */
        .tablo-container {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .tablo-scroll {
            overflow: auto;
            max-height: calc(100vh - 380px);
        }
        
        .tablo {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .tablo thead {
            background: var(--gray-50);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .tablo th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-600);
            border-bottom: 2px solid var(--gray-200);
            white-space: nowrap;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }
        
        .tablo tbody tr {
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .tablo tbody tr:hover {
            background: var(--gray-50);
        }
        
        .tablo tbody tr.selected {
            background: rgba(79, 70, 229, 0.08);
        }
        
        .tablo td {
            padding: 14px 16px;
            color: var(--gray-700);
            white-space: nowrap;
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .bos-veri {
            padding: 60px 20px;
            text-align: center;
            color: var(--gray-400);
            font-size: 15px;
        }
        
        .bos-veri svg {
            width: 64px;
            height: 64px;
            color: var(--gray-300);
            margin-bottom: 16px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }
        
        .modal-baslik {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal-baslik svg {
            width: 24px;
            height: 24px;
            color: var(--primary);
        }
        
        .modal-kapat {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            cursor: pointer;
            color: var(--gray-500);
            transition: all 0.2s;
        }
        
        .modal-kapat:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        
        .modal-kapat svg {
            width: 20px;
            height: 20px;
        }
        
        .modal-body {
            padding: 28px;
            overflow-y: auto;
            flex: 1;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        
        .form-grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .form-grup {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .label {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .input, .select {
            padding: 12px 14px;
            font-size: 14px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            outline: none;
            transition: all 0.2s;
            font-family: inherit;
            background: white;
        }
        
        .input:focus, .select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .input:disabled {
            background: var(--gray-50);
            color: var(--gray-600);
        }
        
        .input.success {
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
            border-color: #A7F3D0;
        }
        
        .input.info {
            background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
            border-color: #BFDBFE;
        }
        
        .input.warning {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border-color: #FCD34D;
        }
        
        .select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 28px;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
        }
        
        .btn-iptal {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: white;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-iptal:hover {
            border-color: var(--gray-300);
            background: var(--gray-50);
        }
        
        .btn-kaydet {
            padding: 12px 28px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-kaydet:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -8px rgba(79, 70, 229, 0.6);
        }
        
        /* Yıl Sonu */
        .yilsonu-container {
            margin-top: 28px;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }
        
        .yilsonu-baslik {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
        }
        
        .yilsonu-ekle {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .yilsonu-btn {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .yilsonu-btn:hover {
            background: var(--primary-dark);
        }
        
        .yilsonu-liste {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 16px;
        }
        
        .yilsonu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
        }
        
        .yilsonu-sil {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--danger-light);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            color: white;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .yilsonu-sil:hover {
            background: var(--danger);
        }
        
        /* Uyarılar */
        .uyari-container {
            padding: 16px 32px;
            background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
            border-bottom: 1px solid #FECACA;
        }
        
        .uyari {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: white;
            border-radius: 10px;
            color: var(--danger);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            border: 1px solid #FECACA;
        }
        
        .uyari:last-child {
            margin-bottom: 0;
        }
        
        .uyari svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .form-grid { grid-template-columns: repeat(2, 1fr); }
            .ozet-container { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 768px) {
            .header { padding: 16px; height: auto; flex-direction: column; gap: 16px; }
            .main { padding: 20px 16px; }
            .form-grid { grid-template-columns: 1fr; }
            .form-grid-3 { grid-template-columns: 1fr; }
            .nav { width: 100%; justify-content: center; }
            .aksiyon-bar { flex-direction: column; align-items: stretch; }
            .arama-container { max-width: 100%; }
            .buton-container { justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==================== FİREBASE SETUP ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDN8_Kt7gk8YFTvBVcJTp9PI47Z2lSZwP8",
            authDomain: "yapidenetimtakip.firebaseapp.com",
            databaseURL: "https://yapidenetimtakip-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "yapidenetimtakip",
            storageBucket: "yapidenetimtakip.firebasestorage.app",
            messagingSenderId: "124645154148",
            appId: "1:124645154148:web:66ae0f9f471f72695cae71"
        };

        // Firebase'i başlat
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Firebase Helper Fonksiyonları
        const FirebaseHelper = {
            // Kullanıcının data ref'ini al
            getUserRef: (path) => {
                const user = auth.currentUser;
                if (!user) return null;
                return database.ref(`users/${user.uid}/${path}`);
            },

            // Veri kaydet
            saveData: async (path, data) => {
                const ref = FirebaseHelper.getUserRef(path);
                if (!ref) return;
                try {
                    await ref.set(data);
                    console.log(`✅ Firebase'e kaydedildi: ${path}`);
                } catch (error) {
                    console.error(`❌ Firebase kayıt hatası: ${path}`, error);
                }
            },

            // Veri oku
            getData: async (path) => {
                const ref = FirebaseHelper.getUserRef(path);
                if (!ref) return null;
                try {
                    const snapshot = await ref.once('value');
                    return snapshot.val();
                } catch (error) {
                    console.error(`❌ Firebase okuma hatası: ${path}`, error);
                    return null;
                }
            },

            // Veri dinle (gerçek zamanlı)
            listenData: (path, callback) => {
                const ref = FirebaseHelper.getUserRef(path);
                if (!ref) return () => {};
                ref.on('value', (snapshot) => {
                    callback(snapshot.val());
                });
                return () => ref.off('value');
            },

            // Çıkış yap
            signOut: () => auth.signOut()
        };

        // SVG İkonları
        const Icons = {
            building: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 21h18M9 8h1M9 12h1M9 16h1M14 8h1M14 12h1M14 16h1M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16"/></svg>,
            plus: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>,
            edit: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            trash: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>,
            search: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>,
            close: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>,
            file: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>,
            concrete: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>,
            money: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>,
            warning: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>,
            arrow: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>,
            empty: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>,
            excel: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M10 9l5 6M10 15l5-6"/></svg>,
            pdf: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M10 13h4M10 17h4"/></svg>,
            dashboard: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            settings: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M3.27 7.5L7 10m10 4l3.73 2.5M3.27 16.5L7 14m10-4l3.73-2.5"/></svg>,
            download: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>,
            upload: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>,
            bell: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/></svg>,
            sun: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>,
            moon: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>,
            filter: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            print: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
        };

        // ==================== SABIT VERİLER ====================
        const KUTAHYA_ILCELERI = ['Merkez', 'Altıntaş', 'Aslanapa', 'Çavdarhisar', 'Domaniç', 'Dumlupınar', 'Emet', 'Gediz', 'Hisarcık', 'Pazarlar', 'Simav', 'Şaphane', 'Tavşanlı'];
        const IS_DURUMLARI = ['Ruhsat başvurusu bekleyen', 'Ruhsat bekleyen', 'Güncel', 'Bitmiş'];
        const YAPI_GRUPLARI = ['1A', '1B', '1C', '2A', '2B', '2C', '3A', '3B', '3C', '4A', '4B', '4C'];
        const BETON_SINIFLARI = ['C16', 'C18', 'C20', 'C25', 'C30', 'C35', 'C40', 'C45', 'C50'];
        const HAKEDIS_DURUMLARI = ['Hakediş ödemesi hazırlanıyor', 'Ödeme bekliyor', 'Belediyeden çıkmış', 'Ödenmiş'];

        const BIRIM_FIYATLAR = {
            2020: { grup12: 537, grup3: 1305, grup4: 2588 },
            2021: { grup12: 673, grup3: 1634, grup4: 3239 },
            2022: { grup12: 1215, grup3: 2940, grup4: 5827 },
            2023: { grup12: 2395, grup3: 5813, grup4: 11522 },
            2024: { grup12: 3455, grup3: 8384, grup4: 16618 },
            '2025/1': { grup12: 4441, grup3: 10776, grup4: 21358 },
            '2025/2': { grup12: 5000, grup3: 15000, grup4: 25000 },
        };

        const HIZMET_ORANLARI_ONCESI = [1.43, 1.50, 1.58, 1.65, 1.74];
        const HIZMET_ORANLARI_SONRASI = {
            kucuk: [1.75, 1.84, 1.93, 2.03, 2.13],   // 500-1000 m²
            orta: [1.50, 1.58, 1.65, 1.74, 1.82],    // 1000-50000 m²
            buyuk: [1.25, 1.31, 1.38, 1.45, 1.52],   // 50000+ m²
        };

        const FIRMA_LISTESI = [
            { id: 'firma1', ad: 'Detay Yapı Denetim', renk: '#4F46E5', gradient: 'linear-gradient(135deg, #4F46E5 0%, #4338CA 100%)' },
            { id: 'firma2', ad: 'Hedef Yapı Denetim', renk: '#059669', gradient: 'linear-gradient(135deg, #059669 0%, #047857 100%)' },
            { id: 'firma3', ad: 'Germiyan Yapı Denetim', renk: '#D97706', gradient: 'linear-gradient(135deg, #D97706 0%, #B45309 100%)' },
        ];

        // ==================== YARDIMCI FONKSİYONLAR ====================
        const formatTarih = (tarih) => {
            if (!tarih) return '-';
            return new Date(tarih).toLocaleDateString('tr-TR');
        };

        const formatPara = (miktar) => {
            if (!miktar && miktar !== 0) return '-';
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2 }).format(miktar);
        };

        const formatSayi = (sayi) => {
            if (!sayi && sayi !== 0) return '-';
            return new Intl.NumberFormat('tr-TR').format(sayi);
        };

        const formatParaPDF = (miktar) => {
            if (!miktar && miktar !== 0) return '-';
            return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(miktar) + ' TL';
        };

        const turkceKarakterTemizle = (metin) => {
            if (!metin) return '';
            return metin
                .replace(/ı/g, 'i')
                .replace(/İ/g, 'I')
                .replace(/ş/g, 's')
                .replace(/Ş/g, 'S')
                .replace(/ğ/g, 'g')
                .replace(/Ğ/g, 'G')
                .replace(/ü/g, 'u')
                .replace(/Ü/g, 'U')
                .replace(/ö/g, 'o')
                .replace(/Ö/g, 'O')
                .replace(/ç/g, 'c')
                .replace(/Ç/g, 'C');
        };

        // ==================== EXCEL AKTARMA FONKSİYONLARI ====================
        const excelAktarProjeler = (projeler, firmaAdi) => {
            const excelVerisi = projeler.map(p => ({
                'YBİF No': p.ybifNo || '',
                'İlçe': p.ilce || '',
                'Proje Adı': p.projeAdi || '',
                'İş Durumu': p.isDurumu || '',
                'Yapı Grubu': p.yapiGrubu || '',
                'Metrekare': parseFloat(p.metrekare) || 0,
                'Güncel Metrekare': parseFloat(p.guncelMetrekare) || parseFloat(p.metrekare) || 0,
                'Kat Adedi': p.katAdedi || 0,
                'Birim Fiyat': parseFloat(p.birimFiyat) || 0,
                'Hizmet Bedeli Oranı': parseFloat(p.hizmetBedeliOrani) || 0,
                'Hizmet Bedeli': parseFloat(p.hizmetBedeli) || 0,
                'Sözleşme Bedeli': parseFloat(p.sozlesmeBedeli) || 0,
                'Sanayi Bölgesi': p.sanayiBolgesi || '',
                'Ruhsat Tarihi': p.ruhsatTarihi || '',
                'Sözleşme Tarihi': p.sozlesmeTarihi || '',
                'Onaylı Seviye': p.onayliSeviye || '',
                'Reel Seviye': p.reelSeviye || '',
                '11 Haziran 2025 Seviyesi': p.haziran2025Seviye || ''
            }));

            const ws = XLSX.utils.json_to_sheet(excelVerisi);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Projeler');
            
            const tarih = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
            XLSX.writeFile(wb, `${firmaAdi}_Projeler_${tarih}.xlsx`);
        };

        const excelAktarBetonlar = (betonlar, firmaAdi) => {
            const excelVerisi = betonlar.map(b => ({
                'YBİF No': b.ybifNo || '',
                'Proje Adı': b.projeAdi || '',
                'Kat Adedi': b.katAdedi || '',
                'Beton Kat': b.betonKat || '',
                'Döküm Tarihi': b.dokumTarihi || '',
                'Beton Sınıfı': b.betonSinifi || '',
                '7 Gün Tarih': b.yediTarih || '',
                '7 Gün Sonuç': b.yediSonuc || '',
                '28 Gün Tarih': b.yirmiSekizTarih || '',
                '28 Gün Sonuç': b.yirmiSekizSonuc || ''
            }));

            const ws = XLSX.utils.json_to_sheet(excelVerisi);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Beton Kayıtları');
            
            const tarih = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
            XLSX.writeFile(wb, `${firmaAdi}_Beton_${tarih}.xlsx`);
        };

        const excelAktarHakedisler = (hakedisler, firmaAdi) => {
            const excelVerisi = hakedisler.map(h => ({
                'YBİF No': h.ybifNo || '',
                'Proje Adı': h.projeAdi || '',
                'Hakediş No': h.hakedisNo || '',
                'Tarih': h.tarih || '',
                'Son Hakediş Yüzdesi': parseFloat(h.sonHakedisYuzdesi) || 0,
                'Kümülatif Yüzde': parseFloat(h.kumulatifYuzde) || 0,
                'Net Hakediş Yüzdesi': parseFloat(h.netHakedisYuzdesi) || 0,
                'Durum': h.durum || '',
                'Sözleşme Bedeli': parseFloat(h.sozlesmeBedeli) || 0,
                'Hakediş Tutarı': parseFloat(h.hakedisTutari) || 0,
                'Kesinti %6': parseFloat(h.kesinti) || 0,
                'Kesintili Bedel': parseFloat(h.kesintiliBedel) || 0,
                'Tevkifat': h.tevkifat || '',
                'KDV': parseFloat(h.kdv) || 0,
                'Tevkifatlı KDV': parseFloat(h.tevkifatliKdv) || 0,
                'Fatura Bedeli': parseFloat(h.faturaBedeli) || 0,
                "KDV'li Yatan Bedel": parseFloat(h.kdvliYatanBedel) || 0
            }));

            const ws = XLSX.utils.json_to_sheet(excelVerisi);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Hakediş Kayıtları');
            
            const tarih = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
            XLSX.writeFile(wb, `${firmaAdi}_Hakedis_${tarih}.xlsx`);
        };

        // ==================== PDF OLUŞTURMA FONKSİYONLARI ====================
        const pdfYapiKayitKarti = (proje, betonlar, hakedisler, firmaAdi) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = 210;
            let y = 25;
            
            // BAŞLIK
            doc.setFillColor(79, 70, 229);
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(26);
            doc.text(turkceKarakterTemizle('YAPI KAYIT KARTI'), pageWidth / 2, 18, { align: 'center' });
            
            doc.setFontSize(13);
            doc.text(turkceKarakterTemizle(firmaAdi), pageWidth / 2, 30, { align: 'center' });
            
            y = 55;
            
            // PROJE BILGILERI
            doc.setFillColor(79, 70, 229);
            doc.rect(15, y, 180, 9, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('PROJE BILGILERI', 20, y + 6);
            doc.setFont(undefined, 'normal');
            
            y += 13;
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            
            const bilgiler = [
                ['YBIF No:', turkceKarakterTemizle(proje.ybifNo || '-')],
                ['Proje:', turkceKarakterTemizle(proje.projeAdi || '-')],
                ['Ilce:', turkceKarakterTemizle(proje.ilce || '-')],
                ['Durum:', turkceKarakterTemizle(proje.isDurumu || '-')],
                ['Yapi Grubu:', turkceKarakterTemizle(proje.yapiGrubu || '-')],
                ['Kat:', (proje.katAdedi || '-') + ' Kat'],
                ['', ''],
                ['Metrekare:', formatSayi(proje.metrekare) + ' m2'],
                ['Guncel M2:', formatSayi(proje.guncelMetrekare || proje.metrekare) + ' m2'],
                ['Birim Fiyat:', formatParaPDF(proje.birimFiyat)],
                ['', ''],
                ['Hizmet Bedeli:', formatParaPDF(proje.hizmetBedeli)],
                ['Sozlesme Bedeli:', formatParaPDF(proje.sozlesmeBedeli)],
                ['', ''],
                ['Ruhsat:', formatTarih(proje.ruhsatTarihi)],
                ['Sanayi Bolgesi:', turkceKarakterTemizle(proje.sanayiBolgesi || '-')],
            ];
            
            let bg = false;
            bilgiler.forEach(([label, value]) => {
                if (label === '') {
                    y += 3;
                    return;
                }
                
                if (bg) {
                    doc.setFillColor(249, 250, 251);
                    doc.rect(15, y - 4, 180, 7, 'F');
                }
                bg = !bg;
                
                doc.setFont(undefined, 'bold');
                doc.text(turkceKarakterTemizle(label), 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(value, 75, y);
                y += 7;
            });
            
            // BETON
            if (betonlar.length > 0) {
                y += 5;
                if (y > 235) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFillColor(67, 56, 202);
                doc.rect(15, y, 180, 9, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('BETON KAYITLARI (' + betonlar.length + ')', 20, y + 6);
                doc.setFont(undefined, 'normal');
                
                y += 13;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                
                betonlar.slice(0, 8).forEach((beton) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(turkceKarakterTemizle(beton.betonKat || '-'), 20, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(turkceKarakterTemizle(beton.betonSinifi || '-'), 50, y);
                    doc.text('Dokum: ' + formatTarih(beton.dokumTarihi), 70, y);
                    
                    y += 5;
                    doc.text('7 gun: ' + turkceKarakterTemizle(beton.yediSonuc || 'Bekliyor'), 25, y);
                    doc.text('28 gun: ' + turkceKarakterTemizle(beton.yirmiSekizSonuc || 'Bekliyor'), 75, y);
                    
                    y += 7;
                });
                
                if (betonlar.length > 8) {
                    doc.setFont(undefined, 'italic');
                    doc.text('... ve ' + (betonlar.length - 8) + ' kayit daha', 20, y);
                    doc.setFont(undefined, 'normal');
                    y += 7;
                }
            }
            
            // HAKEDIS
            if (hakedisler.length > 0) {
                y += 5;
                if (y > 235) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFillColor(5, 150, 105);
                doc.rect(15, y, 180, 9, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('HAKEDIS KAYITLARI (' + hakedisler.length + ')', 20, y + 6);
                doc.setFont(undefined, 'normal');
                
                y += 13;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                
                hakedisler.slice(0, 8).forEach((hakedis) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text('Hakedis ' + turkceKarakterTemizle(hakedis.hakedisNo || '-'), 20, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(turkceKarakterTemizle(hakedis.durum || '-'), 60, y);
                    
                    y += 5;
                    doc.text('Kumulatif: %' + (hakedis.kumulatifYuzde || 0), 25, y);
                    doc.text('Tutar: ' + formatParaPDF(hakedis.hakedisTutari), 75, y);
                    
                    y += 7;
                });
                
                if (hakedisler.length > 8) {
                    doc.setFont(undefined, 'italic');
                    doc.text('... ve ' + (hakedisler.length - 8) + ' kayit daha', 20, y);
                    doc.setFont(undefined, 'normal');
                    y += 7;
                }
            }
            
            // Alt bilgi
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(turkceKarakterTemizle('Olusturma: ' + new Date().toLocaleString('tr-TR')), 15, 285);
            doc.text(proje.ybifNo, 190, 285, { align: 'right' });
            
            const tarih = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
            doc.save(proje.ybifNo + '_Yapi_Kayit_Karti_' + tarih + '.pdf');
        };

        const pdfHakedisFaturasi = (hakedis, proje, firmaAdi) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = 210;
            let y = 25;
            
            // BAŞLIK
            doc.setFillColor(79, 70, 229);
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(26);
            doc.text(turkceKarakterTemizle('HAKEDIS FATURASI'), pageWidth / 2, 18, { align: 'center' });
            
            doc.setFontSize(13);
            doc.text(turkceKarakterTemizle(firmaAdi), pageWidth / 2, 30, { align: 'center' });
            
            y = 55;
            
            // PROJE BILGILERI
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            
            doc.text('YBIF No:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(turkceKarakterTemizle(proje.ybifNo || '-'), 50, y);
            
            doc.setFont(undefined, 'bold');
            doc.text(turkceKarakterTemizle('Hakedis No:'), 120, y);
            doc.setFont(undefined, 'normal');
            doc.text(turkceKarakterTemizle(hakedis.hakedisNo || '-'), 155, y);
            
            y += 8;
            doc.setFont(undefined, 'bold');
            doc.text('Proje:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(turkceKarakterTemizle(proje.projeAdi || '-'), 50, y);
            
            y += 8;
            doc.setFont(undefined, 'bold');
            doc.text('Tarih:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(formatTarih(hakedis.tarih), 50, y);
            
            doc.setFont(undefined, 'bold');
            doc.text('Durum:', 120, y);
            doc.setFont(undefined, 'normal');
            doc.text(turkceKarakterTemizle(hakedis.durum || '-'), 155, y);
            
            y = 90;
            
            // TABLO BAŞLIK
            doc.setFillColor(79, 70, 229);
            doc.rect(15, y, 180, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('ACIKLAMA', 20, y + 7);
            doc.text('TUTAR', 175, y + 7, { align: 'right' });
            doc.setFont(undefined, 'normal');
            
            y += 12;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            
            // Satırlar
            const rows = [
                { l: 'Sozlesme Bedeli', v: formatParaPDF(hakedis.sozlesmeBedeli), bg: true },
                { l: '', v: '', bg: false },
                { l: 'Son Hakedis Yuzdesi', v: '%' + (hakedis.sonHakedisYuzdesi || 0), bg: false },
                { l: 'Kumulatif Yuzde', v: '%' + (hakedis.kumulatifYuzde || 0), bg: true },
                { l: 'Net Hakedis Yuzdesi', v: '%' + (hakedis.netHakedisYuzdesi?.toFixed(2) || 0), bg: false },
                { l: '', v: '', bg: false },
                { l: 'Hakedis Tutari', v: formatParaPDF(hakedis.hakedisTutari), bg: true, bold: true },
                { l: 'Kesinti (%6)', v: '- ' + formatParaPDF(hakedis.kesinti), bg: false },
                { l: 'Kesintili Bedel', v: formatParaPDF(hakedis.kesintiliBedel), bg: true },
                { l: '', v: '', bg: false },
                { l: 'KDV (%20)', v: formatParaPDF(hakedis.kdv), bg: false },
            ];
            
            if (hakedis.tevkifat === 'Evet') {
                rows.push({ l: 'Tevkifatli KDV (%90)', v: '- ' + formatParaPDF(hakedis.tevkifatliKdv), bg: true });
            }
            
            rows.forEach(({ l, v, bg, bold }) => {
                if (l === '') {
                    y += 4;
                    return;
                }
                
                if (bg) {
                    doc.setFillColor(249, 250, 251);
                    doc.rect(15, y - 5, 180, 8, 'F');
                }
                
                if (bold) doc.setFont(undefined, 'bold');
                doc.text(turkceKarakterTemizle(l), 20, y);
                doc.text(v, 190, y, { align: 'right' });
                if (bold) doc.setFont(undefined, 'normal');
                
                y += 8;
            });
            
            // TOPLAMLAR
            y += 6;
            
            // Fatura Bedeli
            doc.setFillColor(219, 234, 254);
            doc.rect(15, y - 5, 180, 11, 'F');
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(29, 78, 216);
            doc.text('FATURA BEDELI', 20, y + 2);
            doc.text(formatParaPDF(hakedis.faturaBedeli), 190, y + 2, { align: 'right' });
            
            y += 16;
            
            // KDV'li Yatan
            doc.setFillColor(220, 252, 231);
            doc.rect(15, y - 5, 180, 11, 'F');
            doc.setTextColor(22, 163, 74);
            doc.text("KDV'LI YATAN BEDEL", 20, y + 2);
            doc.text(formatParaPDF(hakedis.kdvliYatanBedel), 190, y + 2, { align: 'right' });
            doc.setFont(undefined, 'normal');
            
            // Alt bilgi
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            const tarihStr = new Date().toLocaleString('tr-TR');
            doc.text(turkceKarakterTemizle('Olusturma: ' + tarihStr), 15, 285);
            
            const tarih = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
            doc.save(`${proje.ybifNo}_Hakedis_${hakedis.hakedisNo}_${tarih}.pdf`);
        };

        const getBirimFiyat = (ruhsatTarihi, yapiGrubu) => {
            if (!ruhsatTarihi || !yapiGrubu) return 0;
            const tarih = new Date(ruhsatTarihi);
            const yil = tarih.getFullYear();
            const ay = tarih.getMonth() + 1;
            const gun = tarih.getDate();
            
            let fiyatKey;
            if (yil < 2025) {
                fiyatKey = yil;
            } else if (yil === 2025) {
                if (ay < 6 || (ay === 6 && gun < 11)) {
                    fiyatKey = '2025/1';
                } else {
                    fiyatKey = '2025/2';
                }
            } else {
                fiyatKey = '2025/2';
            }
            
            const fiyatlar = BIRIM_FIYATLAR[fiyatKey] || BIRIM_FIYATLAR[2024];
            const grupNo = parseInt(yapiGrubu.charAt(0));
            
            if (grupNo <= 2) return fiyatlar.grup12;
            if (grupNo === 3) return fiyatlar.grup3;
            return fiyatlar.grup4;
        };

        const getHizmetOrani = (ruhsatTarihi, metrekare, yilNo = 1) => {
            if (!ruhsatTarihi) return 0;
            
            const tarih = new Date(ruhsatTarihi);
            const tarihYil = tarih.getFullYear();
            const tarihAy = tarih.getMonth() + 1;
            const tarihGun = tarih.getDate();
            
            const yilIndex = Math.min(yilNo - 1, 4);
            
            // 11.06.2025 öncesi mi kontrol et
            let oncesinde = false;
            if (tarihYil < 2025) {
                oncesinde = true;
            } else if (tarihYil === 2025) {
                if (tarihAy < 6) {
                    oncesinde = true;
                } else if (tarihAy === 6 && tarihGun < 11) {
                    oncesinde = true;
                }
            }
            
            // 11.06.2025 öncesi: tüm metrekareler için sabit oranlar
            if (oncesinde) return HIZMET_ORANLARI_ONCESI[yilIndex];
            
            // 11.06.2025 sonrası: metrekareye göre oran
            if (metrekare < 500) return 0; // Elle girilecek
            else if (metrekare < 1000) return HIZMET_ORANLARI_SONRASI.kucuk[yilIndex];
            else if (metrekare < 50000) return HIZMET_ORANLARI_SONRASI.orta[yilIndex];
            else return HIZMET_ORANLARI_SONRASI.buyuk[yilIndex];
        };

        const hesaplaHizmetBedeli = (metrekare, birimFiyat, oran, sanayiBolgesi) => {
            let bedel = metrekare * birimFiyat * (oran / 100);
            if (sanayiBolgesi === 'Evet') bedel = bedel * 0.65;
            return bedel;
        };

        // ==================== GRAFİK COMPONENT'LERİ ====================
        function PastaGrafik({ projeler }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                // Tüm projeleri topla
                let tumProjeler = [];
                Object.values(projeler).forEach(firmaProjeler => {
                    tumProjeler = [...tumProjeler, ...firmaProjeler];
                });

                // Durum bazlı sayma
                const durumlar = {
                    'Ruhsat başvurusu bekleyen': 0,
                    'Ruhsat bekleyen': 0,
                    'Güncel': 0,
                    'Bitmiş': 0
                };

                tumProjeler.forEach(proje => {
                    if (durumlar.hasOwnProperty(proje.isDurumu)) {
                        durumlar[proje.isDurumu]++;
                    }
                });

                // Eski chart'ı yok et
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                // Yeni chart oluştur
                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Başvuru Bekleyen', 'Ruhsat Bekleyen', 'Güncel', 'Bitmiş'],
                        datasets: [{
                            data: [
                                durumlar['Ruhsat başvurusu bekleyen'],
                                durumlar['Ruhsat bekleyen'],
                                durumlar['Güncel'],
                                durumlar['Bitmiş']
                            ],
                            backgroundColor: [
                                '#F59E0B',
                                '#3B82F6',
                                '#10B981',
                                '#6B7280'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return label + ': ' + value + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [projeler]);

            return (
                <div style={{
                    background: 'white',
                    borderRadius: '16px',
                    padding: '24px',
                    boxShadow: 'var(--shadow-md)'
                }}>
                    <h3 style={{
                        fontSize: '18px',
                        fontWeight: '700',
                        color: 'var(--gray-800)',
                        marginBottom: '20px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}>
                        📊 Proje Durumları
                    </h3>
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        }

        function CubukGrafik({ firmaOzetleri }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                // Eski chart'ı yok et
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                // Yeni chart oluştur
                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: firmaOzetleri.map(f => f.ad),
                        datasets: [
                            {
                                label: 'Toplam Proje',
                                data: firmaOzetleri.map(f => f.projeCount),
                                backgroundColor: 'rgba(79, 70, 229, 0.8)',
                                borderColor: 'rgba(79, 70, 229, 1)',
                                borderWidth: 2
                            },
                            {
                                label: 'Güncel Proje',
                                data: firmaOzetleri.map(f => f.guncelProje),
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [firmaOzetleri]);

            return (
                <div style={{
                    background: 'white',
                    borderRadius: '16px',
                    padding: '24px',
                    boxShadow: 'var(--shadow-md)'
                }}>
                    <h3 style={{
                        fontSize: '18px',
                        fontWeight: '700',
                        color: 'var(--gray-800)',
                        marginBottom: '20px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                    }}>
                        📈 Firma Karşılaştırması
                    </h3>
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        }

        // ==================== AYARLAR SAYFASI ====================
        function AyarlarSayfasi({ projeler, setProjeler, betonlar, setBetonlar, hakedisler, setHakedisler, firmaId, firmaRenk }) {
            const [onayModal, setOnayModal] = useState(null);
            const fileInputRef = useRef(null);

            const handleYedekAl = () => {
                const yedekData = {
                    tarih: new Date().toISOString(),
                    versiyon: '1.0',
                    projeler,
                    betonlar,
                    hakedisler
                };

                const dataStr = JSON.stringify(yedekData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `yapi_denetim_yedek_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '-')}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleGeriYukle = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const yedekData = JSON.parse(e.target.result);
                        if (yedekData.projeler) setProjeler(yedekData.projeler);
                        if (yedekData.betonlar) setBetonlar(yedekData.betonlar);
                        if (yedekData.hakedisler) setHakedisler(yedekData.hakedisler);
                        alert('Veriler başarıyla geri yüklendi!');
                    } catch (error) {
                        alert('Hata: Geçersiz yedek dosyası!');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const handleFirmaSil = () => {
                const firma = FIRMA_LISTESI.find(f => f.id === firmaId);
                setOnayModal({
                    baslik: `${firma.ad} Verilerini Sil`,
                    mesaj: `${firma.ad} firmasına ait TÜM veriler silinecek. Bu işlem geri alınamaz!`,
                    onay: () => {
                        const yeniProjeler = { ...projeler };
                        const yeniBetonlar = { ...betonlar };
                        const yeniHakedisler = { ...hakedisler };
                        delete yeniProjeler[firmaId];
                        delete yeniBetonlar[firmaId];
                        delete yeniHakedisler[firmaId];
                        setProjeler(yeniProjeler);
                        setBetonlar(yeniBetonlar);
                        setHakedisler(yeniHakedisler);
                        setOnayModal(null);
                        alert('Firma verileri silindi!');
                    }
                });
            };

            const handleTumVerileriSil = () => {
                setOnayModal({
                    baslik: 'TÜM VERİLERİ SİL',
                    mesaj: '3 firmanın TÜM verileri silinecek! Bu işlem geri alınamaz. Devam etmek istediğinizden emin misiniz?',
                    onay: () => {
                        setProjeler({});
                        setBetonlar({});
                        setHakedisler({});
                        localStorage.clear();
                        setOnayModal(null);
                        alert('Tüm veriler silindi!');
                    }
                });
            };

            const firma = FIRMA_LISTESI.find(f => f.id === firmaId);

            // İstatistikler
            const istatistikler = {
                projeSayisi: (projeler[firmaId] || []).length,
                betonSayisi: (betonlar[firmaId] || []).length,
                hakedisSayisi: (hakedisler[firmaId] || []).length,
                toplamProje: Object.values(projeler).reduce((t, arr) => t + arr.length, 0),
                toplamBeton: Object.values(betonlar).reduce((t, arr) => t + arr.length, 0),
                toplamHakedis: Object.values(hakedisler).reduce((t, arr) => t + arr.length, 0),
            };

            return (
                <div className="sayfa-container">
                    <div className="sayfa-header">
                        <div>
                            <h1 className="sayfa-baslik">Ayarlar & Veri Yönetimi</h1>
                            <p className="sayfa-aciklama">Yedekleme, geri yükleme ve veri yönetimi</p>
                        </div>
                    </div>

                    {/* İstatistikler */}
                    <div style={{
                        background: 'white',
                        borderRadius: '16px',
                        padding: '24px',
                        marginBottom: '24px',
                        boxShadow: 'var(--shadow-md)',
                        border: `3px solid ${firmaRenk}20`
                    }}>
                        <h2 style={{
                            fontSize: '18px',
                            fontWeight: '700',
                            color: firmaRenk,
                            marginBottom: '20px'
                        }}>
                            📊 Veri İstatistikleri
                        </h2>
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                            gap: '16px'
                        }}>
                            <div style={{
                                padding: '16px',
                                background: 'var(--gray-50)',
                                borderRadius: '12px',
                                borderLeft: `4px solid ${firmaRenk}`
                            }}>
                                <div style={{fontSize: '12px', color: 'var(--gray-600)', marginBottom: '4px'}}>
                                    {firma.ad} - Projeler
                                </div>
                                <div style={{fontSize: '24px', fontWeight: '700', color: firmaRenk}}>
                                    {istatistikler.projeSayisi}
                                </div>
                            </div>
                            <div style={{
                                padding: '16px',
                                background: 'var(--gray-50)',
                                borderRadius: '12px',
                                borderLeft: `4px solid #4338CA`
                            }}>
                                <div style={{fontSize: '12px', color: 'var(--gray-600)', marginBottom: '4px'}}>
                                    {firma.ad} - Beton
                                </div>
                                <div style={{fontSize: '24px', fontWeight: '700', color: '#4338CA'}}>
                                    {istatistikler.betonSayisi}
                                </div>
                            </div>
                            <div style={{
                                padding: '16px',
                                background: 'var(--gray-50)',
                                borderRadius: '12px',
                                borderLeft: `4px solid #059669`
                            }}>
                                <div style={{fontSize: '12px', color: 'var(--gray-600)', marginBottom: '4px'}}>
                                    {firma.ad} - Hakediş
                                </div>
                                <div style={{fontSize: '24px', fontWeight: '700', color: '#059669'}}>
                                    {istatistikler.hakedisSayisi}
                                </div>
                            </div>
                        </div>

                        <div style={{
                            marginTop: '20px',
                            paddingTop: '20px',
                            borderTop: '2px solid var(--gray-200)',
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                            gap: '16px'
                        }}>
                            <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '12px'}}>
                                <div style={{fontSize: '12px', color: 'var(--gray-600)'}}>Toplam Proje (Tüm Firmalar)</div>
                                <div style={{fontSize: '20px', fontWeight: '700', color: 'var(--gray-800)'}}>
                                    {istatistikler.toplamProje}
                                </div>
                            </div>
                            <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '12px'}}>
                                <div style={{fontSize: '12px', color: 'var(--gray-600)'}}>Toplam Beton (Tüm Firmalar)</div>
                                <div style={{fontSize: '20px', fontWeight: '700', color: 'var(--gray-800)'}}>
                                    {istatistikler.toplamBeton}
                                </div>
                            </div>
                            <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '12px'}}>
                                <div style={{fontSize: '12px', color: 'var(--gray-600)'}}>Toplam Hakediş (Tüm Firmalar)</div>
                                <div style={{fontSize: '20px', fontWeight: '700', color: 'var(--gray-800)'}}>
                                    {istatistikler.toplamHakedis}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Yedekleme & Geri Yükleme */}
                    <div style={{
                        background: 'white',
                        borderRadius: '16px',
                        padding: '24px',
                        marginBottom: '24px',
                        boxShadow: 'var(--shadow-md)'
                    }}>
                        <h2 style={{
                            fontSize: '18px',
                            fontWeight: '700',
                            color: 'var(--gray-800)',
                            marginBottom: '20px'
                        }}>
                            💾 Yedekleme & Geri Yükleme
                        </h2>
                        <div style={{display: 'grid', gap: '16px'}}>
                            <div style={{
                                padding: '20px',
                                background: 'linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%)',
                                borderRadius: '12px',
                                border: '2px solid #059669'
                            }}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px'}}>
                                    <span style={{fontSize: '24px'}}>💾</span>
                                    <div>
                                        <h3 style={{fontSize: '16px', fontWeight: '700', color: '#047857'}}>
                                            Yedek Al
                                        </h3>
                                        <p style={{fontSize: '13px', color: '#065F46', marginTop: '4px'}}>
                                            Tüm firmaların verilerini JSON dosyası olarak kaydet
                                        </p>
                                    </div>
                                </div>
                                <button 
                                    onClick={handleYedekAl}
                                    style={{
                                        background: 'linear-gradient(135deg, #059669 0%, #047857 100%)',
                                        color: 'white',
                                        padding: '12px 24px',
                                        borderRadius: '10px',
                                        border: 'none',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        fontSize: '14px'
                                    }}
                                >
                                    {Icons.download} Yedek Dosyası İndir
                                </button>
                            </div>

                            <div style={{
                                padding: '20px',
                                background: 'linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%)',
                                borderRadius: '12px',
                                border: '2px solid #2563EB'
                            }}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px'}}>
                                    <span style={{fontSize: '24px'}}>📥</span>
                                    <div>
                                        <h3 style={{fontSize: '16px', fontWeight: '700', color: '#1E40AF'}}>
                                            Geri Yükle
                                        </h3>
                                        <p style={{fontSize: '13px', color: '#1E3A8A', marginTop: '4px'}}>
                                            Yedek dosyasından verileri geri yükle (Mevcut veriler üzerine yazılır)
                                        </p>
                                    </div>
                                </div>
                                <input 
                                    type="file"
                                    ref={fileInputRef}
                                    accept=".json"
                                    onChange={handleGeriYukle}
                                    style={{display: 'none'}}
                                />
                                <button 
                                    onClick={() => fileInputRef.current.click()}
                                    style={{
                                        background: 'linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%)',
                                        color: 'white',
                                        padding: '12px 24px',
                                        borderRadius: '10px',
                                        border: 'none',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        fontSize: '14px'
                                    }}
                                >
                                    {Icons.upload} Yedek Dosyası Seç
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Çoklu Cihaz Kullanımı */}
                    <div style={{
                        background: 'white',
                        borderRadius: '16px',
                        padding: '24px',
                        marginBottom: '24px',
                        boxShadow: 'var(--shadow-md)'
                    }}>
                        <h2 style={{
                            fontSize: '18px',
                            fontWeight: '700',
                            color: 'var(--gray-800)',
                            marginBottom: '20px'
                        }}>
                            🌐 Çoklu Cihaz Kullanımı
                        </h2>
                        <div style={{
                            padding: '20px',
                            background: 'linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%)',
                            borderRadius: '12px',
                            border: '2px solid #3B82F6'
                        }}>
                            <h3 style={{fontSize: '16px', fontWeight: '700', color: '#1E40AF', marginBottom: '12px'}}>
                                ✨ Firebase ile Otomatik Senkronizasyon
                            </h3>
                            <p style={{
                                fontSize: '14px',
                                color: '#1E3A8A',
                                marginBottom: '16px',
                                lineHeight: '1.8'
                            }}>
                                Tüm verileriniz Firebase bulutunda güvenle saklanıyor ve tüm cihazlarınızda otomatik olarak senkronize ediliyor!
                            </p>
                            <ol style={{
                                fontSize: '14px',
                                color: '#1E3A8A',
                                marginLeft: '20px',
                                lineHeight: '1.8'
                            }}>
                                <li><strong>1. Herhangi Bir Cihazda:</strong> Giriş yaptığınız hesapla proje ekleyin</li>
                                <li><strong>2. Otomatik Kayıt:</strong> Değişiklikler anında Firebase'e kaydedilir</li>
                                <li><strong>3. Diğer Cihazlar:</strong> Aynı hesapla giriş yapın, tüm veriler orada!</li>
                                <li><strong>4. Gerçek Zamanlı:</strong> Bir cihazda yaptığınız değişiklikler diğerlerinde anında görünür</li>
                            </ol>
                            <div style={{
                                marginTop: '16px',
                                padding: '12px',
                                background: 'rgba(255,255,255,0.6)',
                                borderRadius: '8px',
                                fontSize: '13px',
                                color: '#1E40AF'
                            }}>
                                <strong>🔒 Güvenlik:</strong> Her kullanıcı sadece kendi verilerini görür. Firebase güvenlik kuralları ile korunmaktadır.
                            </div>
                            <div style={{
                                marginTop: '12px',
                                padding: '12px',
                                background: 'rgba(255,255,255,0.6)',
                                borderRadius: '8px',
                                fontSize: '13px',
                                color: '#1E40AF'
                            }}>
                                <strong>💾 Yedekleme İpucu:</strong> Düzenli olarak "Yedek Al" butonunu kullanarak manuel yedek alabilirsiniz. Bu yedekler bilgisayarınıza indirilir ve ek güvenlik sağlar.
                            </div>
                        </div>
                    </div>

                    {/* Veri Silme */}
                    <div style={{
                        background: 'white',
                        borderRadius: '16px',
                        padding: '24px',
                        boxShadow: 'var(--shadow-md)'
                    }}>
                        <h2 style={{
                            fontSize: '18px',
                            fontWeight: '700',
                            color: 'var(--gray-800)',
                            marginBottom: '20px'
                        }}>
                            🗑️ Veri Silme
                        </h2>
                        <div style={{display: 'grid', gap: '16px'}}>
                            <div style={{
                                padding: '20px',
                                background: 'linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%)',
                                borderRadius: '12px',
                                border: '2px solid #D97706'
                            }}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px'}}>
                                    <span style={{fontSize: '24px'}}>⚠️</span>
                                    <div>
                                        <h3 style={{fontSize: '16px', fontWeight: '700', color: '#92400E'}}>
                                            {firma.ad} Verilerini Sil
                                        </h3>
                                        <p style={{fontSize: '13px', color: '#78350F', marginTop: '4px'}}>
                                            Sadece bu firmanın tüm verileri silinir
                                        </p>
                                    </div>
                                </div>
                                <button 
                                    onClick={handleFirmaSil}
                                    style={{
                                        background: 'linear-gradient(135deg, #D97706 0%, #B45309 100%)',
                                        color: 'white',
                                        padding: '12px 24px',
                                        borderRadius: '10px',
                                        border: 'none',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    Firma Verilerini Sil
                                </button>
                            </div>

                            <div style={{
                                padding: '20px',
                                background: 'linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%)',
                                borderRadius: '12px',
                                border: '2px solid #DC2626'
                            }}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px'}}>
                                    <span style={{fontSize: '24px'}}>💣</span>
                                    <div>
                                        <h3 style={{fontSize: '16px', fontWeight: '700', color: '#991B1B'}}>
                                            TÜM VERİLERİ SİL
                                        </h3>
                                        <p style={{fontSize: '13px', color: '#7F1D1D', marginTop: '4px'}}>
                                            3 firmanın TÜM verileri kalıcı olarak silinir! GERİ ALINAMAZ!
                                        </p>
                                    </div>
                                </div>
                                <button 
                                    onClick={handleTumVerileriSil}
                                    style={{
                                        background: 'linear-gradient(135deg, #DC2626 0%, #B91C1C 100%)',
                                        color: 'white',
                                        padding: '12px 24px',
                                        borderRadius: '10px',
                                        border: 'none',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    TÜM VERİLERİ SİL
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Onay Modalı */}
                    {onayModal && (
                        <div className="modal-overlay" onClick={() => setOnayModal(null)}>
                            <div className="modal-content" style={{maxWidth: '500px'}} onClick={e => e.stopPropagation()}>
                                <div className="modal-header" style={{background: 'linear-gradient(135deg, #DC262615 0%, #DC262605 100%)'}}>
                                    <h2 className="modal-baslik" style={{color: '#DC2626'}}>
                                        ⚠️ {onayModal.baslik}
                                    </h2>
                                    <button onClick={() => setOnayModal(null)} className="modal-kapat">{Icons.close}</button>
                                </div>
                                <div className="modal-body">
                                    <p style={{fontSize: '15px', lineHeight: '1.6', color: 'var(--gray-700)'}}>
                                        {onayModal.mesaj}
                                    </p>
                                </div>
                                <div className="modal-footer">
                                    <button onClick={() => setOnayModal(null)} className="btn" style={{background: 'var(--gray-500)'}}>
                                        İptal
                                    </button>
                                    <button onClick={onayModal.onay} style={{
                                        background: 'linear-gradient(135deg, #DC2626 0%, #B91C1C 100%)',
                                        color: 'white',
                                        padding: '12px 24px',
                                        borderRadius: '10px',
                                        border: 'none',
                                        fontWeight: '600',
                                        cursor: 'pointer'
                                    }}>
                                        Evet, Sil
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ==================== DASHBOARD SAYFASI ====================
        function DashboardSayfasi({ projeler, betonlar, hakedisler, setSeciliFirma, setAktifSayfa }) {
            // Tüm firmaların toplamı
            const tumFirmalarOzet = {
                toplamProje: 0,
                toplamMetrekare: 0,
                toplamHizmetBedeli: 0,
                guncelProjeler: 0,
                bitmisProjeler: 0,
                toplamHakedis: 0,
                toplamBeton: 0,
            };

            FIRMA_LISTESI.forEach(firma => {
                const firmaProjeler = projeler[firma.id] || [];
                const firmaBetonlar = betonlar[firma.id] || [];
                const firmaHakedisler = hakedisler[firma.id] || [];

                tumFirmalarOzet.toplamProje += firmaProjeler.length;
                tumFirmalarOzet.toplamMetrekare += firmaProjeler
                    .filter(p => p.isDurumu === 'Güncel')
                    .reduce((t, p) => t + (parseFloat(p.guncelMetrekare) || parseFloat(p.metrekare) || 0), 0);
                tumFirmalarOzet.toplamHizmetBedeli += firmaProjeler.reduce((t, p) => t + (parseFloat(p.hizmetBedeli) || 0), 0);
                tumFirmalarOzet.guncelProjeler += firmaProjeler.filter(p => p.isDurumu === 'Güncel').length;
                tumFirmalarOzet.bitmisProjeler += firmaProjeler.filter(p => p.isDurumu === 'Bitmiş').length;
                tumFirmalarOzet.toplamHakedis += firmaHakedisler.reduce((t, h) => t + (parseFloat(h.kdvliYatanBedel) || 0), 0);
                tumFirmalarOzet.toplamBeton += firmaBetonlar.length;
            });

            // Firma bazlı özet
            const firmaOzetleri = FIRMA_LISTESI.map(firma => {
                const firmaProjeler = projeler[firma.id] || [];
                const firmaHakedisler = hakedisler[firma.id] || [];

                return {
                    ...firma,
                    projeCount: firmaProjeler.length,
                    guncelProje: firmaProjeler.filter(p => p.isDurumu === 'Güncel').length,
                    hizmetBedeli: firmaProjeler.reduce((t, p) => t + (parseFloat(p.hizmetBedeli) || 0), 0),
                    hakedisToplamı: firmaHakedisler
                        .filter(h => h.durum === 'Ödenmiş')
                        .reduce((t, h) => t + (parseFloat(h.kdvliYatanBedel) || 0), 0),
                };
            });

            const handleFirmaClick = (firmaId) => {
                setSeciliFirma(firmaId);
                setAktifSayfa('proje');
            };

            return (
                <div className="sayfa-container">
                    <div className="sayfa-header">
                        <div>
                            <h1 className="sayfa-baslik">Dashboard</h1>
                            <p className="sayfa-aciklama">Tüm firmaların genel görünümü</p>
                        </div>
                    </div>

                    {/* Toplam Özet Kartları */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                        gap: '16px',
                        marginBottom: '32px'
                    }}>
                        {[
                            { label: 'Toplam Proje', value: tumFirmalarOzet.toplamProje, icon: '📊', color: '#4F46E5' },
                            { label: 'Güncel Projeler', value: tumFirmalarOzet.guncelProjeler, icon: '✅', color: '#059669' },
                            { label: 'Bitmiş Projeler', value: tumFirmalarOzet.bitmisProjeler, icon: '🏁', color: '#6B7280' },
                            { label: 'Toplam Metrekare', value: `${formatSayi(tumFirmalarOzet.toplamMetrekare)} m²`, icon: '📐', color: '#EC4899' },
                            { label: 'Hizmet Bedeli', value: formatPara(tumFirmalarOzet.toplamHizmetBedeli), icon: '💰', color: '#7C3AED', small: true },
                            { label: 'Ödenen Hakediş', value: formatPara(tumFirmalarOzet.toplamHakedis), icon: '💵', color: '#059669', small: true },
                            { label: 'Beton Kayıtları', value: tumFirmalarOzet.toplamBeton, icon: '🏗️', color: '#4338CA' },
                        ].map((kart, index) => (
                            <div key={index} className="ozet-kart" style={{
                                background: 'white',
                                borderRadius: '16px',
                                padding: '20px',
                                borderLeft: `4px solid ${kart.color}`,
                                boxShadow: 'var(--shadow-md)',
                                transition: 'all 0.3s ease',
                            }}>
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between',
                                    marginBottom: '8px'
                                }}>
                                    <span style={{fontSize: '24px'}}>{kart.icon}</span>
                                    <span className="ozet-deger" style={{
                                        fontSize: kart.small ? '22px' : '28px',
                                        fontWeight: '700',
                                        color: kart.color
                                    }}>
                                        {kart.value}
                                    </span>
                                </div>
                                <div className="ozet-label" style={{
                                    fontSize: '13px',
                                    color: 'var(--gray-600)',
                                    fontWeight: '500'
                                }}>
                                    {kart.label}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Grafikler */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))',
                        gap: '24px',
                        marginBottom: '32px'
                    }}>
                        <PastaGrafik projeler={projeler} />
                        <CubukGrafik firmaOzetleri={firmaOzetleri} />
                    </div>

                    {/* Firma Kartları */}
                    <h2 style={{
                        fontSize: '20px',
                        fontWeight: '700',
                        color: 'var(--gray-800)',
                        marginBottom: '16px'
                    }}>
                        Firmalar
                    </h2>

                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))',
                        gap: '24px'
                    }}>
                        {firmaOzetleri.map(firma => (
                            <div 
                                key={firma.id}
                                style={{
                                    background: 'white',
                                    borderRadius: '20px',
                                    padding: '28px',
                                    boxShadow: 'var(--shadow-lg)',
                                    border: `3px solid ${firma.renk}`,
                                    cursor: 'pointer',
                                    transition: 'all 0.3s ease',
                                    position: 'relative',
                                    overflow: 'hidden'
                                }}
                                onClick={() => handleFirmaClick(firma.id)}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.transform = 'translateY(-8px)';
                                    e.currentTarget.style.boxShadow = 'var(--shadow-xl)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.transform = 'translateY(0)';
                                    e.currentTarget.style.boxShadow = 'var(--shadow-lg)';
                                }}
                            >
                                {/* Arka plan dekoratif */}
                                <div style={{
                                    position: 'absolute',
                                    top: '-50px',
                                    right: '-50px',
                                    width: '150px',
                                    height: '150px',
                                    background: firma.renk,
                                    opacity: '0.1',
                                    borderRadius: '50%'
                                }}></div>

                                {/* Firma Adı */}
                                <h3 style={{
                                    fontSize: '22px',
                                    fontWeight: '700',
                                    color: firma.renk,
                                    marginBottom: '20px',
                                    position: 'relative'
                                }}>
                                    {firma.ad}
                                </h3>

                                {/* Bilgiler */}
                                <div style={{display: 'grid', gap: '12px', position: 'relative'}}>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        padding: '12px',
                                        background: 'var(--gray-50)',
                                        borderRadius: '10px'
                                    }}>
                                        <span style={{fontSize: '14px', color: 'var(--gray-600)'}}>
                                            📊 Toplam Proje
                                        </span>
                                        <span style={{fontSize: '18px', fontWeight: '700', color: firma.renk}}>
                                            {firma.projeCount}
                                        </span>
                                    </div>

                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        padding: '12px',
                                        background: 'var(--gray-50)',
                                        borderRadius: '10px'
                                    }}>
                                        <span style={{fontSize: '14px', color: 'var(--gray-600)'}}>
                                            ✅ Güncel Proje
                                        </span>
                                        <span style={{fontSize: '18px', fontWeight: '700', color: '#059669'}}>
                                            {firma.guncelProje}
                                        </span>
                                    </div>

                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        padding: '12px',
                                        background: 'var(--gray-50)',
                                        borderRadius: '10px'
                                    }}>
                                        <span style={{fontSize: '14px', color: 'var(--gray-600)'}}>
                                            💰 Hizmet Bedeli
                                        </span>
                                        <span style={{fontSize: '16px', fontWeight: '700', color: '#7C3AED'}}>
                                            {formatPara(firma.hizmetBedeli)}
                                        </span>
                                    </div>

                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        padding: '12px',
                                        background: 'var(--gray-50)',
                                        borderRadius: '10px'
                                    }}>
                                        <span style={{fontSize: '14px', color: 'var(--gray-600)'}}>
                                            💵 Ödenen Hakediş
                                        </span>
                                        <span style={{fontSize: '16px', fontWeight: '700', color: '#059669'}}>
                                            {formatPara(firma.hakedisToplamı)}
                                        </span>
                                    </div>
                                </div>

                                {/* Detaya Git İkonu */}
                                <div style={{
                                    marginTop: '16px',
                                    display: 'flex',
                                    justifyContent: 'flex-end',
                                    alignItems: 'center',
                                    color: firma.renk,
                                    fontSize: '14px',
                                    fontWeight: '600'
                                }}>
                                    Detaya Git {Icons.arrow}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ==================== ANA UYGULAMA ====================
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [seciliFirma, setSeciliFirma] = useState(null);
            const [aktifSayfa, setAktifSayfa] = useState('dashboard');
            const [projeler, setProjeler] = useState({});
            const [betonlar, setBetonlar] = useState({});
            const [hakedisler, setHakedisler] = useState({});
            const [aramaMetni, setAramaMetni] = useState('');
            const [uyarilar, setUyarilar] = useState([]);
            const [darkMode, setDarkMode] = useState(() => {
                const saved = localStorage.getItem('yapiDenetim_darkMode');
                return saved === 'true';
            });

            // Auth State Dinle
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return unsubscribe;
            }, []);

            // Firebase'den veri yükle (kullanıcı giriş yaptığında)
            useEffect(() => {
                if (!user) return;

                const loadFromFirebase = async () => {
                    try {
                        const [fbProjeler, fbBetonlar, fbHakedisler] = await Promise.all([
                            FirebaseHelper.getData('projeler'),
                            FirebaseHelper.getData('betonlar'),
                            FirebaseHelper.getData('hakedisler')
                        ]);

                        if (fbProjeler) setProjeler(fbProjeler);
                        if (fbBetonlar) setBetonlar(fbBetonlar);
                        if (fbHakedisler) setHakedisler(fbHakedisler);

                        console.log('✅ Firebase\'den veriler yüklendi!');
                    } catch (error) {
                        console.error('❌ Firebase yükleme hatası:', error);
                    }
                };

                loadFromFirebase();

                // Gerçek zamanlı dinle
                const unsubProjeler = FirebaseHelper.listenData('projeler', (data) => {
                    if (data) setProjeler(data);
                });
                const unsubBetonlar = FirebaseHelper.listenData('betonlar', (data) => {
                    if (data) setBetonlar(data);
                });
                const unsubHakedisler = FirebaseHelper.listenData('hakedisler', (data) => {
                    if (data) setHakedisler(data);
                });

                return () => {
                    unsubProjeler();
                    unsubBetonlar();
                    unsubHakedisler();
                };
            }, [user]);

            // LocalStorage yedekleme (offline destek)
            useEffect(() => {
                try {
                    const kayitliProjeler = localStorage.getItem('yapiDenetim_projeler');
                    const kayitliBetonlar = localStorage.getItem('yapiDenetim_betonlar');
                    const kayitliHakedisler = localStorage.getItem('yapiDenetim_hakedisler');
                    if (!user && kayitliProjeler) setProjeler(JSON.parse(kayitliProjeler));
                    if (!user && kayitliBetonlar) setBetonlar(JSON.parse(kayitliBetonlar));
                    if (!user && kayitliHakedisler) setHakedisler(JSON.parse(kayitliHakedisler));
                } catch (e) { console.log('LocalStorage yüklenemedi'); }
            }, [user]);

            // Projeler değişince hem localStorage hem Firebase'e kaydet
            useEffect(() => {
                try { localStorage.setItem('yapiDenetim_projeler', JSON.stringify(projeler)); } catch(e) {}
                if (user && Object.keys(projeler).length > 0) {
                    FirebaseHelper.saveData('projeler', projeler);
                }
            }, [projeler, user]);

            useEffect(() => {
                try { localStorage.setItem('yapiDenetim_betonlar', JSON.stringify(betonlar)); } catch(e) {}
                if (user && Object.keys(betonlar).length > 0) {
                    FirebaseHelper.saveData('betonlar', betonlar);
                }
            }, [betonlar, user]);

            useEffect(() => {
                try { localStorage.setItem('yapiDenetim_hakedisler', JSON.stringify(hakedisler)); } catch(e) {}
                if (user && Object.keys(hakedisler).length > 0) {
                    FirebaseHelper.saveData('hakedisler', hakedisler);
                }
            }, [hakedisler, user]);

            useEffect(() => {
                document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
                localStorage.setItem('yapiDenetim_darkMode', darkMode);
            }, [darkMode]);

            useEffect(() => {
                if (!seciliFirma) return;
                const firmaBetonlari = betonlar[seciliFirma] || [];
                const bugun = new Date();
                const yeniUyarilar = [];
                firmaBetonlari.forEach(beton => {
                    if (beton.yirmiSekizTarih && !beton.yirmiSekizSonuc) {
                        const yirmiSekizTarih = new Date(beton.yirmiSekizTarih);
                        if (bugun >= yirmiSekizTarih) {
                            yeniUyarilar.push(`YBİF ${beton.ybifNo}: 28 günlük beton test sonucu girilmedi!`);
                        }
                    }
                });
                setUyarilar(yeniUyarilar);
            }, [seciliFirma, betonlar]);

            // Loading ekranı
            if (loading) {
                return (
                    <div style={{
                        minHeight: '100vh',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                    }}>
                        <div style={{
                            background: 'white',
                            padding: '40px',
                            borderRadius: '20px',
                            textAlign: 'center',
                            boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                        }}>
                            <div style={{
                                width: '50px',
                                height: '50px',
                                border: '5px solid #f3f3f3',
                                borderTop: '5px solid #667eea',
                                borderRadius: '50%',
                                animation: 'spin 1s linear infinite',
                                margin: '0 auto 20px'
                            }}></div>
                            <p style={{color: '#666', fontSize: '16px'}}>Yükleniyor...</p>
                        </div>
                    </div>
                );
            }

            // Giriş yapılmamışsa login sayfasına yönlendir
            if (!user) {
                window.location.href = 'yapi-denetim-firebase.html';
                return null;
            }

            if (!seciliFirma) return <FirmaSecimEkrani onFirmaSecim={setSeciliFirma} />;

            const firmaBilgisi = FIRMA_LISTESI.find(f => f.id === seciliFirma);

            return (
                <div>
                    <header className="header" style={{ borderBottom: `3px solid ${firmaBilgisi.renk}` }}>
                        <div className="header-left">
                            <div className="logo-container">
                                <div className="logo-icon">{Icons.building}</div>
                                <span className="logo-text">Yapı Denetim</span>
                            </div>
                            <select 
                                value={seciliFirma} 
                                onChange={(e) => setSeciliFirma(e.target.value)}
                                className="firma-select"
                            >
                                {FIRMA_LISTESI.map(firma => (
                                    <option key={firma.id} value={firma.id}>{firma.ad}</option>
                                ))}
                            </select>
                        </div>
                        <nav className="nav">
                            {[
                                { key: 'dashboard', label: 'Dashboard', icon: Icons.dashboard },
                                { key: 'proje', label: 'Proje Bilgileri', icon: Icons.file },
                                { key: 'beton', label: 'Beton', icon: Icons.concrete },
                                { key: 'hakedis', label: 'Hakediş', icon: Icons.money },
                                { key: 'ayarlar', label: 'Ayarlar', icon: Icons.settings }
                            ].map(({ key, label, icon }) => (
                                <button 
                                    key={key}
                                    onClick={() => { setAktifSayfa(key); setAramaMetni(''); }}
                                    className={`nav-btn ${aktifSayfa === key ? 'active' : ''}`}
                                >
                                    {icon}
                                    {label}
                                </button>
                            ))}
                        </nav>
                        <div className="header-right">
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                marginRight: '16px',
                                padding: '8px 16px',
                                background: 'var(--bg-secondary)',
                                borderRadius: '10px'
                            }}>
                                <span style={{fontSize: '14px', color: 'var(--text-secondary)'}}>
                                    👤 {user?.email}
                                </span>
                                <button
                                    onClick={() => {
                                        if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                                            FirebaseHelper.signOut();
                                        }
                                    }}
                                    style={{
                                        padding: '6px 12px',
                                        background: 'linear-gradient(135deg, #DC2626 0%, #B91C1C 100%)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        fontSize: '13px',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                                    onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                                >
                                    Çıkış
                                </button>
                            </div>
                            <button 
                                className="theme-toggle" 
                                onClick={() => setDarkMode(!darkMode)}
                                title={darkMode ? "Açık Tema" : "Koyu Tema"}
                            >
                                {darkMode ? Icons.sun : Icons.moon}
                            </button>
                        </div>
                    </header>

                    {uyarilar.length > 0 && (
                        <div className="uyari-container">
                            {uyarilar.map((uyari, index) => (
                                <div key={index} className="uyari">{Icons.warning} {uyari}</div>
                            ))}
                        </div>
                    )}

                    <main className="main">
                        {aktifSayfa === 'dashboard' && (
                            <DashboardSayfasi 
                                projeler={projeler}
                                betonlar={betonlar}
                                hakedisler={hakedisler}
                                setSeciliFirma={setSeciliFirma}
                                setAktifSayfa={setAktifSayfa}
                            />
                        )}
                        {aktifSayfa === 'proje' && (
                            <ProjeSayfasi 
                                firmaId={seciliFirma}
                                projeler={projeler[seciliFirma] || []}
                                setProjeler={(yeniProjeler) => setProjeler({...projeler, [seciliFirma]: yeniProjeler})}
                                betonlar={betonlar[seciliFirma] || []}
                                hakedisler={hakedisler[seciliFirma] || []}
                                aramaMetni={aramaMetni}
                                setAramaMetni={setAramaMetni}
                                firmaRenk={firmaBilgisi.renk}
                            />
                        )}
                        {aktifSayfa === 'beton' && (
                            <BetonSayfasi 
                                firmaId={seciliFirma}
                                betonlar={betonlar[seciliFirma] || []}
                                setBetonlar={(yeniBetonlar) => setBetonlar({...betonlar, [seciliFirma]: yeniBetonlar})}
                                projeler={projeler[seciliFirma] || []}
                                aramaMetni={aramaMetni}
                                setAramaMetni={setAramaMetni}
                                firmaRenk={firmaBilgisi.renk}
                            />
                        )}
                        {aktifSayfa === 'hakedis' && (
                            <HakedisSayfasi 
                                firmaId={seciliFirma}
                                hakedisler={hakedisler[seciliFirma] || []}
                                setHakedisler={(yeniHakedisler) => setHakedisler({...hakedisler, [seciliFirma]: yeniHakedisler})}
                                projeler={projeler[seciliFirma] || []}
                                setProjeler={(yeniProjeler) => setProjeler({...projeler, [seciliFirma]: yeniProjeler})}
                                aramaMetni={aramaMetni}
                                setAramaMetni={setAramaMetni}
                                firmaRenk={firmaBilgisi.renk}
                            />
                        )}
                        {aktifSayfa === 'ayarlar' && (
                            <AyarlarSayfasi 
                                projeler={projeler}
                                setProjeler={setProjeler}
                                betonlar={betonlar}
                                setBetonlar={setBetonlar}
                                hakedisler={hakedisler}
                                setHakedisler={setHakedisler}
                                firmaId={seciliFirma}
                                firmaRenk={firmaBilgisi.renk}
                            />
                        )}
                    </main>
                </div>
            );
        }

        // ==================== FİRMA SEÇİM EKRANI ====================
        function FirmaSecimEkrani({ onFirmaSecim }) {
            return (
                <div className="firma-secim">
                    <div className="firma-card">
                        <div className="firma-header">
                            <div className="firma-logo">{Icons.building}</div>
                            <h1 className="firma-title">Yapı Denetim İş Takip</h1>
                            <p className="firma-subtitle">Çalışmak istediğiniz firmayı seçin</p>
                        </div>
                        <div className="firma-buttons">
                            {FIRMA_LISTESI.map(firma => (
                                <button
                                    key={firma.id}
                                    onClick={() => onFirmaSecim(firma.id)}
                                    className="firma-btn"
                                    style={{ background: firma.gradient, color: 'white' }}
                                >
                                    <div className="firma-btn-icon">🏢</div>
                                    <span className="firma-btn-text">{firma.ad}</span>
                                    <span className="firma-btn-arrow">{Icons.arrow}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== PROJE SAYFASI ====================
        function ProjeSayfasi({ firmaId, projeler, setProjeler, betonlar, hakedisler, aramaMetni, setAramaMetni, firmaRenk }) {
            const [modalAcik, setModalAcik] = useState(false);
            const [modalTipi, setModalTipi] = useState('ekle');
            const [seciliProje, setSeciliProje] = useState(null);
            const [detayModalAcik, setDetayModalAcik] = useState(false);
            const [detayProje, setDetayProje] = useState(null);
            const [filtrelerAcik, setFiltrelerAcik] = useState(false);
            const [filtreler, setFiltreler] = useState({
                durum: 'Tümü',
                yapiGrubu: 'Tümü',
                ilce: 'Tümü',
                sanayiBolgesi: 'Tümü',
                minMetrekare: '',
                maxMetrekare: '',
                minHizmetBedeli: '',
                maxHizmetBedeli: ''
            });

            // Filtre paneli dışına tıklayınca kapat
            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (filtrelerAcik && !e.target.closest('.filtre-panel') && !e.target.closest('.filtre-toggle-btn')) {
                        setFiltrelerAcik(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [filtrelerAcik]);

            const handleYbifTiklama = (proje) => {
                setDetayProje(proje);
                setDetayModalAcik(true);
            };

            const handleExcelAktar = () => {
                const firma = FIRMA_LISTESI.find(f => f.id === firmaId);
                excelAktarProjeler(filtrelenmisProje, firma.ad);
            };

            const handleYazdir = () => {
                window.print();
            };

            const ozet = {
                toplamProje: projeler.length,
                ruhsatBasvuruBekleyen: projeler.filter(p => p.isDurumu === 'Ruhsat başvurusu bekleyen').length,
                ruhsatBekleyen: projeler.filter(p => p.isDurumu === 'Ruhsat bekleyen').length,
                guncel: projeler.filter(p => p.isDurumu === 'Güncel').length,
                bitmis: projeler.filter(p => p.isDurumu === 'Bitmiş').length,
                toplamHizmetBedeli: projeler.reduce((t, p) => t + (parseFloat(p.hizmetBedeli) || 0), 0),
                toplamMetrekare: projeler.filter(p => p.isDurumu === 'Güncel').reduce((t, p) => t + (parseFloat(p.guncelMetrekare) || parseFloat(p.metrekare) || 0), 0),
            };

            const filtrelenmisProje = projeler.filter(p => {
                // Arama metni filtresi
                const aramaEslesiyor = p.ybifNo?.toLowerCase().includes(aramaMetni.toLowerCase()) ||
                                      p.projeAdi?.toLowerCase().includes(aramaMetni.toLowerCase());
                if (!aramaEslesiyor) return false;

                // Durum filtresi
                if (filtreler.durum !== 'Tümü' && p.isDurumu !== filtreler.durum) return false;

                // Yapı Grubu filtresi
                if (filtreler.yapiGrubu !== 'Tümü' && p.yapiGrubu !== filtreler.yapiGrubu) return false;

                // İlçe filtresi
                if (filtreler.ilce !== 'Tümü' && p.ilce !== filtreler.ilce) return false;

                // Sanayi Bölgesi filtresi
                if (filtreler.sanayiBolgesi !== 'Tümü' && p.sanayiBolgesi !== filtreler.sanayiBolgesi) return false;

                // Metrekare aralığı filtresi
                const metrekare = parseFloat(p.guncelMetrekare || p.metrekare) || 0;
                if (filtreler.minMetrekare && metrekare < parseFloat(filtreler.minMetrekare)) return false;
                if (filtreler.maxMetrekare && metrekare > parseFloat(filtreler.maxMetrekare)) return false;

                // Hizmet Bedeli aralığı filtresi
                const hizmetBedeli = parseFloat(p.hizmetBedeli) || 0;
                if (filtreler.minHizmetBedeli && hizmetBedeli < parseFloat(filtreler.minHizmetBedeli)) return false;
                if (filtreler.maxHizmetBedeli && hizmetBedeli > parseFloat(filtreler.maxHizmetBedeli)) return false;

                return true;
            }).sort((a, b) => {
                const ybifA = a.ybifNo || '';
                const ybifB = b.ybifNo || '';
                return ybifB.localeCompare(ybifA, undefined, { numeric: true });
            });

            const filtreTemizle = () => {
                setFiltreler({
                    durum: 'Tümü',
                    yapiGrubu: 'Tümü',
                    ilce: 'Tümü',
                    sanayiBolgesi: 'Tümü',
                    minMetrekare: '',
                    maxMetrekare: '',
                    minHizmetBedeli: '',
                    maxHizmetBedeli: ''
                });
                setAramaMetni('');
            };

            // Benzersiz değerleri çıkart
            const durumlar = ['Tümü', ...new Set(projeler.map(p => p.isDurumu).filter(Boolean))];
            const yapiGruplari = ['Tümü', ...new Set(projeler.map(p => p.yapiGrubu).filter(Boolean))];
            const ilceler = ['Tümü', ...new Set(projeler.map(p => p.ilce).filter(Boolean))];

            const handleEkle = () => { setModalTipi('ekle'); setSeciliProje(null); setModalAcik(true); };
            const handleGuncelle = () => {
                if (!seciliProje) { alert('Lütfen güncellemek için bir proje seçin'); return; }
                setModalTipi('guncelle'); setModalAcik(true);
            };
            const handleSil = () => {
                if (!seciliProje) { alert('Lütfen silmek için bir proje seçin'); return; }
                if (confirm(`"${seciliProje.projeAdi}" projesini silmek istediğinize emin misiniz?`)) {
                    setProjeler(projeler.filter(p => p.id !== seciliProje.id));
                    setSeciliProje(null);
                }
            };
            const handleSatirCiftTiklama = (proje) => { setSeciliProje(proje); setModalTipi('guncelle'); setModalAcik(true); };
            const handleKaydet = (projeVerisi) => {
                if (modalTipi === 'ekle') {
                    setProjeler([...projeler, { ...projeVerisi, id: Date.now(), guncelMetrekare: projeVerisi.metrekare }]);
                } else {
                    setProjeler(projeler.map(p => p.id === seciliProje.id ? {...projeVerisi, id: seciliProje.id} : p));
                }
                setModalAcik(false); setSeciliProje(null);
            };

            const getIsDurumuRenk = (durum) => {
                const renkler = {
                    'Ruhsat başvurusu bekleyen': { bg: '#FEF3C7', color: '#D97706' },
                    'Ruhsat bekleyen': { bg: '#DBEAFE', color: '#2563EB' },
                    'Güncel': { bg: '#D1FAE5', color: '#059669' },
                    'Bitmiş': { bg: '#E5E7EB', color: '#4B5563' }
                };
                return renkler[durum] || { bg: '#F3F4F6', color: '#6B7280' };
            };

            const ozetKartlari = [
                { label: 'Toplam Proje', value: ozet.toplamProje, color: firmaRenk, icon: '📊' },
                { label: 'Başvuru Bekleyen', value: ozet.ruhsatBasvuruBekleyen, color: '#D97706', icon: '⏳' },
                { label: 'Ruhsat Bekleyen', value: ozet.ruhsatBekleyen, color: '#2563EB', icon: '📋' },
                { label: 'Güncel', value: ozet.guncel, color: '#059669', icon: '✅' },
                { label: 'Bitmiş', value: ozet.bitmis, color: '#6B7280', icon: '🏁' },
                { label: 'Hizmet Bedeli', value: formatPara(ozet.toplamHizmetBedeli), color: '#7C3AED', icon: '💰', small: true },
                { label: 'Güncel Metrekare', value: `${formatSayi(ozet.toplamMetrekare)} m²`, color: '#EC4899', icon: '📐' },
            ];

            return (
                <div>
                    <div className="ozet-container">
                        {ozetKartlari.map((item, i) => (
                            <div key={i} className="ozet-kart" style={{ '--kart-renk': item.color }}>
                                <div style={{ position: 'absolute', top: 0, left: 0, width: '4px', height: '100%', background: item.color, borderRadius: '16px 0 0 16px' }}></div>
                                <div className="ozet-icon" style={{ background: `${item.color}15`, color: item.color }}>{item.icon}</div>
                                <div className="ozet-baslik">{item.label}</div>
                                <div className={`ozet-deger ${item.small ? 'small' : ''}`}>{item.value}</div>
                            </div>
                        ))}
                    </div>

                    <div className="aksiyon-bar">
                        <div className="buton-container">
                            <button onClick={handleEkle} className="btn btn-ekle">{Icons.plus} Yeni Proje</button>
                            <button onClick={handleGuncelle} className="btn btn-guncelle">{Icons.edit} Düzenle</button>
                            <button onClick={handleSil} className="btn btn-sil">{Icons.trash} Sil</button>
                            <button onClick={handleExcelAktar} className="btn btn-excel">{Icons.excel} Excel'e Aktar</button>
                            <button onClick={handleYazdir} className="btn btn-print">{Icons.print} Yazdır</button>
                        </div>
                        <div className="arama-container">
                            <span className="arama-icon">{Icons.search}</span>
                            <input
                                type="text"
                                placeholder="YBİF No veya Proje Adı ara..."
                                value={aramaMetni}
                                onChange={(e) => setAramaMetni(e.target.value)}
                                className="arama-input"
                            />
                            <button 
                                onClick={() => setFiltrelerAcik(!filtrelerAcik)} 
                                className="filtre-toggle-btn"
                                title="Gelişmiş Filtreler"
                            >
                                {Icons.filter}
                                {Object.values(filtreler).some(v => v && v !== 'Tümü') && (
                                    <span className="filtre-badge">●</span>
                                )}
                            </button>
                        </div>

                        {/* Gelişmiş Filtreler Paneli */}
                        {filtrelerAcik && (
                            <div className="filtre-panel">
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                    <h3 style={{fontSize: '16px', fontWeight: '700', color: 'var(--text-primary)'}}>
                                        🔍 Gelişmiş Filtreler
                                    </h3>
                                    <div style={{display: 'flex', gap: '8px'}}>
                                        <button onClick={filtreTemizle} className="btn" style={{padding: '6px 12px', fontSize: '13px'}}>
                                            Sıfırla
                                        </button>
                                        <button 
                                            onClick={() => setFiltrelerAcik(false)} 
                                            className="btn" 
                                            style={{padding: '6px 12px', fontSize: '13px', background: 'var(--gray-500)'}}
                                        >
                                            Kapat
                                        </button>
                                    </div>
                                </div>
                                
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '12px'}}>
                                    {/* Durum Filtresi */}
                                    <div>
                                        <label style={{fontSize: '12px', fontWeight: '600', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px'}}>
                                            İş Durumu
                                        </label>
                                        <select 
                                            value={filtreler.durum}
                                            onChange={(e) => setFiltreler({...filtreler, durum: e.target.value})}
                                            style={{width: '100%', padding: '8px', borderRadius: '6px', border: '1px solid var(--border-color)', background: 'var(--card-bg)', color: 'var(--text-primary)'}}
                                        >
                                            {durumlar.map(d => <option key={d} value={d}>{d}</option>)}
                                        </select>
                                    </div>

                                    {/* Yapı Grubu Filtresi */}
                                    <div>
                                        <label style={{fontSize: '12px', fontWeight: '600', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px'}}>
                                            Yapı Grubu
                                        </label>
                                        <select 
                                            value={filtreler.yapiGrubu}
                                            onChange={(e) => setFiltreler({...filtreler, yapiGrubu: e.target.value})}
                                            style={{width: '100%', padding: '8px', borderRadius: '6px', border: '1px solid var(--border-color)', background: 'var(--card-bg)', color: 'var(--text-primary)'}}
                                        >
                                            {yapiGruplari.map(y => <option key={y} value={y}>{y}</option>)}
                                        </select>
                                    </div>

                                    {/* İlçe Filtresi */}
                                    <div>
                                        <label style={{fontSize: '12px', fontWeight: '600', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px'}}>
                                            İlçe
                                        </label>
                                        <select 
                                            value={filtreler.ilce}
                                            onChange={(e) => setFiltreler({...filtreler, ilce: e.target.value})}
                                            style={{width: '100%', padding: '8px', borderRadius: '6px', border: '1px solid var(--border-color)', background: 'var(--card-bg)', color: 'var(--text-primary)'}}
                                        >
                                            {ilceler.map(i => <option key={i} value={i}>{i}</option>)}
                                        </select>
                                    </div>

                                    {/* Sanayi Bölgesi Filtresi */}
                                    <div>
                                        <label style={{fontSize: '12px', fontWeight: '600', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px'}}>
                                            Sanayi Bölgesi
                                        </label>
                                        <select 
                                            value={filtreler.sanayiBolgesi}
                                            onChange={(e) => setFiltreler({...filtreler, sanayiBolgesi: e.target.value})}
                                            style={{width: '100%', padding: '8px', borderRadius: '6px', border: '1px solid var(--border-color)', background: 'var(--card-bg)', color: 'var(--text-primary)'}}
                                        >
                                            <option value="Tümü">Tümü</option>
                                            <option value="Evet">Evet</option>
                                            <option value="Hayır">Hayır</option>
                                        </select>
                                    </div>

                                    {/* Metrekare Aralığı */}
                                    <div>
                                        <label style={{fontSize: '12px', fontWeight: '600', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px'}}>
                                            Min Metrekare
                                        </label>
                                        <input 
                                            type="number"
                                            value={filtreler.minMetrekare}
                                            onChange={(e) => setFiltreler({...filtreler, minMetrekare: e.target.value})}
                                            placeholder="0"
                                            style={{width: '100%', padding: '8px', borderRadius: '6px', border: '1px solid var(--border-color)', background: 'var(--card-bg)', color: 'var(--text-primary)'}}
                                        />
                                    </div>

                                    <div>
                                        <label style={{fontSize: '12px', fontWeight: '600', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px'}}>
                                            Max Metrekare
                                        </label>
                                        <input 
                                            type="number"
                                            value={filtreler.maxMetrekare}
                                            onChange={(e) => setFiltreler({...filtreler, maxMetrekare: e.target.value})}
                                            placeholder="10000"
                                            style={{width: '100%', padding: '8px', borderRadius: '6px', border: '1px solid var(--border-color)', background: 'var(--card-bg)', color: 'var(--text-primary)'}}
                                        />
                                    </div>

                                    {/* Hizmet Bedeli Aralığı */}
                                    <div>
                                        <label style={{fontSize: '12px', fontWeight: '600', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px'}}>
                                            Min Hizmet Bedeli
                                        </label>
                                        <input 
                                            type="number"
                                            value={filtreler.minHizmetBedeli}
                                            onChange={(e) => setFiltreler({...filtreler, minHizmetBedeli: e.target.value})}
                                            placeholder="0"
                                            style={{width: '100%', padding: '8px', borderRadius: '6px', border: '1px solid var(--border-color)', background: 'var(--card-bg)', color: 'var(--text-primary)'}}
                                        />
                                    </div>

                                    <div>
                                        <label style={{fontSize: '12px', fontWeight: '600', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px'}}>
                                            Max Hizmet Bedeli
                                        </label>
                                        <input 
                                            type="number"
                                            value={filtreler.maxHizmetBedeli}
                                            onChange={(e) => setFiltreler({...filtreler, maxHizmetBedeli: e.target.value})}
                                            placeholder="1000000"
                                            style={{width: '100%', padding: '8px', borderRadius: '6px', border: '1px solid var(--border-color)', background: 'var(--card-bg)', color: 'var(--text-primary)'}}
                                        />
                                    </div>
                                </div>

                                <div style={{marginTop: '12px', fontSize: '13px', color: 'var(--text-secondary)'}}>
                                    Toplam {filtrelenmisProje.length} proje gösteriliyor
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="tablo-container">
                        <div className="tablo-scroll">
                            <table className="tablo">
                                <thead>
                                    <tr>
                                        {['YBİF No', 'İlçe', 'Proje Adı', 'İş Durumu', 'Yapı Grubu', 'Onaylı Seviye', 'Reel Seviye', 'Metrekare', 'Güncel M²', 'Birim Fiyat', 'Hizmet Bedeli', 'Sözleşme Bedeli', 'Ruhsat Tarihi'].map(h => (
                                            <th key={h}>{h}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {filtrelenmisProje.map(proje => (
                                        <tr 
                                            key={proje.id}
                                            onClick={() => setSeciliProje(proje)}
                                            onDoubleClick={() => handleSatirCiftTiklama(proje)}
                                            className={seciliProje?.id === proje.id ? 'selected' : ''}
                                        >
                                            <td>
                                            <strong 
                                                style={{color: firmaRenk, cursor: 'pointer', textDecoration: 'underline'}}
                                                onClick={(e) => { e.stopPropagation(); handleYbifTiklama(proje); }}
                                            >
                                                {proje.ybifNo}
                                            </strong>
                                        </td>
                                            <td>{proje.ilce}</td>
                                            <td>{proje.projeAdi}</td>
                                            <td>
                                                <span className="badge" style={{ 
                                                    backgroundColor: getIsDurumuRenk(proje.isDurumu).bg, 
                                                    color: getIsDurumuRenk(proje.isDurumu).color 
                                                }}>
                                                    {proje.isDurumu}
                                                </span>
                                            </td>
                                            <td>{proje.yapiGrubu}</td>
                                            <td className="seviye-onayli" style={{
                                                background: 'linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%)',
                                                color: '#2563EB',
                                                fontWeight: '600',
                                                textAlign: 'center'
                                            }}>
                                                {proje.onayliSeviye ? `%${proje.onayliSeviye}` : '-'}
                                            </td>
                                            <td className="seviye-reel" style={{
                                                background: 'linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%)',
                                                color: '#D97706',
                                                fontWeight: '600',
                                                textAlign: 'center'
                                            }}>
                                                {proje.reelSeviye ? `%${proje.reelSeviye}` : '-'}
                                            </td>
                                            <td>{formatSayi(proje.metrekare)} m²</td>
                                            <td>{formatSayi(proje.guncelMetrekare || proje.metrekare)} m²</td>
                                            <td>{formatPara(proje.birimFiyat)}</td>
                                            <td><strong className="hizmet-bedeli" style={{color: '#059669'}}>{formatPara(proje.hizmetBedeli)}</strong></td>
                                            <td><strong className="sozlesme-bedeli" style={{color: '#2563EB'}}>{formatPara(proje.sozlesmeBedeli)}</strong></td>
                                            <td>{formatTarih(proje.ruhsatTarihi)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {filtrelenmisProje.length === 0 && (
                                <div className="bos-veri">
                                    {Icons.empty}
                                    <div>{aramaMetni ? 'Arama kriterlerine uygun proje bulunamadı' : 'Henüz proje eklenmedi'}</div>
                                </div>
                            )}
                        </div>
                    </div>

                    {modalAcik && <ProjeModal proje={modalTipi === 'guncelle' ? seciliProje : null} onKaydet={handleKaydet} onKapat={() => { setModalAcik(false); setSeciliProje(null); }} baslik={modalTipi === 'ekle' ? 'Yeni Proje Ekle' : 'Proje Düzenle'} />}
                    {detayModalAcik && <ProjeDetayModal proje={detayProje} betonlar={betonlar} hakedisler={hakedisler} firmaId={firmaId} onKapat={() => setDetayModalAcik(false)} firmaRenk={firmaRenk} />}
                </div>
            );
        }

        // ==================== PROJE MODAL ====================
        function ProjeModal({ proje, onKaydet, onKapat, baslik }) {
            const [form, setForm] = useState({
                ybifNo: proje?.ybifNo || '', il: 'Kütahya', ilce: proje?.ilce || '', projeAdi: proje?.projeAdi || '',
                isDurumu: proje?.isDurumu || 'Ruhsat başvurusu bekleyen', onayliSeviye: proje?.onayliSeviye || '',
                reelSeviye: proje?.reelSeviye || '', yilSonuSeviyeleri: proje?.yilSonuSeviyeleri || [],
                haziran2025Seviye: proje?.haziran2025Seviye || '', yapiGrubu: proje?.yapiGrubu || '1A',
                birimFiyat: proje?.birimFiyat || 0, hizmetBedeliOrani: proje?.hizmetBedeliOrani || '',
                sanayiBolgesi: proje?.sanayiBolgesi || 'Hayır', katAdedi: proje?.katAdedi || 1,
                metrekare: proje?.metrekare || '', guncelMetrekare: proje?.guncelMetrekare || '',
                hizmetBedeli: proje?.hizmetBedeli || 0, sozlesmeBedeli: proje?.sozlesmeBedeli || 0,
                sozlesmeTarihi: proje?.sozlesmeTarihi || '', ruhsatTarihi: proje?.ruhsatTarihi || '',
            });
            const [yeniYilSonu, setYeniYilSonu] = useState({ yil: '', seviye: '' });
            const [manuelOranDuzenleme, setManuelOranDuzenleme] = useState(false); // Manuel düzenleme modu

            useEffect(() => {
                if (form.ruhsatTarihi && form.yapiGrubu) {
                    const birimFiyat = getBirimFiyat(form.ruhsatTarihi, form.yapiGrubu);
                    const metrekare = parseFloat(form.metrekare) || 0;
                    
                    // Otomatik oran hesapla
                    const otomatikOran = getHizmetOrani(form.ruhsatTarihi, metrekare, 1);
                    
                    // Manuel düzenleme modundaysa, oranı güncelleme
                    let oran = otomatikOran > 0 ? otomatikOran : parseFloat(form.hizmetBedeliOrani) || 0;
                    const hizmetBedeli = hesaplaHizmetBedeli(parseFloat(form.guncelMetrekare || form.metrekare) || 0, birimFiyat, oran || 1.43, form.sanayiBolgesi);
                    const sozlesmeBedeli = hesaplaHizmetBedeli(metrekare, birimFiyat, oran || 1.43, form.sanayiBolgesi);
                    
                    // DÜZELTME: Manuel düzenlemedeyse oranı değiştirme!
                    if (manuelOranDuzenleme) {
                        // Manuel düzenlemedeyken sadece hizmet bedellerini güncelle, oranı değiştirme
                        oran = parseFloat(form.hizmetBedeliOrani) || 0;
                        const hizmetBedeli = hesaplaHizmetBedeli(parseFloat(form.guncelMetrekare || form.metrekare) || 0, birimFiyat, oran || 1.43, form.sanayiBolgesi);
                        const sozlesmeBedeli = hesaplaHizmetBedeli(metrekare, birimFiyat, oran || 1.43, form.sanayiBolgesi);
                        setForm(prev => ({ ...prev, birimFiyat, hizmetBedeli, sozlesmeBedeli: proje ? prev.sozlesmeBedeli : sozlesmeBedeli }));
                    } else {
                        // Otomatik modda oran güncellenir
                        setForm(prev => ({ ...prev, birimFiyat, hizmetBedeli, sozlesmeBedeli: proje ? prev.sozlesmeBedeli : sozlesmeBedeli, hizmetBedeliOrani: otomatikOran > 0 ? otomatikOran : prev.hizmetBedeliOrani }));
                    }
                }
            }, [form.ruhsatTarihi, form.yapiGrubu, form.metrekare, form.guncelMetrekare, form.sanayiBolgesi, form.hizmetBedeliOrani, manuelOranDuzenleme]);

            const handleYilSonuEkle = () => {
                if (yeniYilSonu.yil && yeniYilSonu.seviye) {
                    setForm(prev => ({ ...prev, yilSonuSeviyeleri: [...prev.yilSonuSeviyeleri, {...yeniYilSonu}] }));
                    setYeniYilSonu({ yil: '', seviye: '' });
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!form.ybifNo || !form.projeAdi) { alert('YBİF No ve Proje Adı zorunludur'); return; }
                onKaydet(form);
            };

            return (
                <div className="modal-overlay" onClick={onKapat}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-baslik">{Icons.file} {baslik}</h2>
                            <button onClick={onKapat} className="modal-kapat">{Icons.close}</button>
                        </div>
                        <div className="modal-body">
                            <form onSubmit={handleSubmit}>
                                <div className="form-grid">
                                    <div className="form-grup">
                                        <label className="label">YBİF No *</label>
                                        <input type="text" value={form.ybifNo} onChange={e => setForm({...form, ybifNo: e.target.value})} className="input" required />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">İl</label>
                                        <input type="text" value="Kütahya" disabled className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">İlçe</label>
                                        <select value={form.ilce} onChange={e => setForm({...form, ilce: e.target.value})} className="select">
                                            <option value="">Seçiniz</option>
                                            {KUTAHYA_ILCELERI.map(ilce => <option key={ilce} value={ilce}>{ilce}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Proje Adı *</label>
                                        <input type="text" value={form.projeAdi} onChange={e => setForm({...form, projeAdi: e.target.value})} className="input" required />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">İş Durumu</label>
                                        <select value={form.isDurumu} onChange={e => setForm({...form, isDurumu: e.target.value})} className="select">
                                            {IS_DURUMLARI.map(d => <option key={d} value={d}>{d}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Yapı Grubu</label>
                                        <select value={form.yapiGrubu} onChange={e => setForm({...form, yapiGrubu: e.target.value})} className="select">
                                            {YAPI_GRUPLARI.map(g => <option key={g} value={g}>{g}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Sanayi Bölgesi</label>
                                        <select value={form.sanayiBolgesi} onChange={e => setForm({...form, sanayiBolgesi: e.target.value})} className="select">
                                            <option value="Hayır">Hayır</option>
                                            <option value="Evet">Evet</option>
                                        </select>
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Kat Adedi</label>
                                        <select value={form.katAdedi} onChange={e => setForm({...form, katAdedi: parseInt(e.target.value)})} className="select">
                                            {[...Array(10)].map((_, i) => <option key={i+1} value={i+1}>{i+1}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Metrekare</label>
                                        <input type="number" value={form.metrekare} onChange={e => setForm({...form, metrekare: e.target.value, guncelMetrekare: proje ? form.guncelMetrekare : e.target.value})} className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Güncel Metrekare</label>
                                        <input type="number" value={form.guncelMetrekare || form.metrekare} onChange={e => setForm({...form, guncelMetrekare: e.target.value})} className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">
                                            Hizmet Oranı (%)
                                            {manuelOranDuzenleme && (
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        setManuelOranDuzenleme(false);
                                                        // Otomatik hesaplamayı tetikle
                                                        const metrekare = parseFloat(form.metrekare) || 0;
                                                        const otomatikOran = getHizmetOrani(form.ruhsatTarihi, metrekare, 1);
                                                        setForm(prev => ({...prev, hizmetBedeliOrani: otomatikOran}));
                                                    }}
                                                    style={{
                                                        marginLeft: '8px',
                                                        padding: '4px 8px',
                                                        fontSize: '11px',
                                                        background: 'linear-gradient(135deg, #10B981 0%, #059669 100%)',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        fontWeight: '600'
                                                    }}
                                                >
                                                    ↻ Otomatik Hesapla
                                                </button>
                                            )}
                                        </label>
                                        <input 
                                            type="number" 
                                            step="0.01" 
                                            value={form.hizmetBedeliOrani} 
                                            onChange={e => {
                                                setForm({...form, hizmetBedeliOrani: e.target.value});
                                                setManuelOranDuzenleme(true); // Manuel düzenleme moduna geç
                                            }} 
                                            className="input" 
                                            placeholder="Otomatik hesaplanır veya elle girin"
                                            style={{
                                                borderColor: manuelOranDuzenleme ? '#F59E0B' : undefined,
                                                background: manuelOranDuzenleme ? '#FEF3C7' : undefined
                                            }}
                                        />
                                        {manuelOranDuzenleme && (
                                            <div style={{fontSize: '11px', color: '#D97706', marginTop: '4px'}}>
                                                ⚠️ Manuel düzenleme modu aktif
                                            </div>
                                        )}
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Birim Fiyat</label>
                                        <input type="text" value={formatPara(form.birimFiyat)} disabled className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Onaylı Seviye (%)</label>
                                        <input type="number" value={form.onayliSeviye} onChange={e => setForm({...form, onayliSeviye: e.target.value})} className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Reel Seviye (%)</label>
                                        <input type="number" value={form.reelSeviye} onChange={e => setForm({...form, reelSeviye: e.target.value})} className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">11 Haziran 2025 Seviyesi (%)</label>
                                        <input type="number" value={form.haziran2025Seviye} onChange={e => setForm({...form, haziran2025Seviye: e.target.value})} className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Sözleşme Tarihi</label>
                                        <input type="date" value={form.sozlesmeTarihi} onChange={e => setForm({...form, sozlesmeTarihi: e.target.value})} className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Ruhsat Tarihi</label>
                                        <input type="date" value={form.ruhsatTarihi} onChange={e => setForm({...form, ruhsatTarihi: e.target.value})} className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Hizmet Bedeli</label>
                                        <input type="text" value={formatPara(form.hizmetBedeli)} disabled className="input success" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Sözleşme Bedeli</label>
                                        <input type="text" value={formatPara(form.sozlesmeBedeli)} disabled className="input info" />
                                    </div>
                                </div>

                                <div className="yilsonu-container">
                                    <div className="yilsonu-baslik">Yıl Sonu Seviyeleri</div>
                                    <div className="yilsonu-ekle">
                                        <div className="form-grup" style={{marginBottom: 0}}>
                                            <label className="label">Yıl</label>
                                            <input type="number" placeholder="2024" value={yeniYilSonu.yil} onChange={e => setYeniYilSonu({...yeniYilSonu, yil: e.target.value})} className="input" style={{width: '100px'}} />
                                        </div>
                                        <div className="form-grup" style={{marginBottom: 0}}>
                                            <label className="label">Seviye (%)</label>
                                            <input type="number" placeholder="35" value={yeniYilSonu.seviye} onChange={e => setYeniYilSonu({...yeniYilSonu, seviye: e.target.value})} className="input" style={{width: '100px'}} />
                                        </div>
                                        <button type="button" onClick={handleYilSonuEkle} className="yilsonu-btn">+ Ekle</button>
                                    </div>
                                    {form.yilSonuSeviyeleri.length > 0 && (
                                        <div className="yilsonu-liste">
                                            {form.yilSonuSeviyeleri.map((ys, i) => (
                                                <div key={i} className="yilsonu-item">
                                                    <span><strong>{ys.yil}</strong>: %{ys.seviye}</span>
                                                    <button type="button" onClick={() => setForm(prev => ({...prev, yilSonuSeviyeleri: prev.yilSonuSeviyeleri.filter((_, idx) => idx !== i)}))} className="yilsonu-sil">✕</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="modal-footer" style={{margin: '28px -28px -28px', borderRadius: '0 0 20px 20px'}}>
                                    <button type="button" onClick={onKapat} className="btn-iptal">İptal</button>
                                    <button type="submit" className="btn-kaydet">{proje ? 'Güncelle' : 'Kaydet'}</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== PROJE DETAY MODAL ====================
        function ProjeDetayModal({ proje, betonlar, hakedisler, firmaId, onKapat, firmaRenk }) {
            const projeBetonlari = betonlar.filter(b => b.ybifNo === proje.ybifNo);
            const projeHakedisleri = hakedisler.filter(h => h.ybifNo === proje.ybifNo);

            const getDurumRenk = (durum) => {
                const renkler = {
                    'Ruhsat başvurusu bekleyen': { bg: '#FEF3C7', color: '#D97706' },
                    'Ruhsat bekleyen': { bg: '#DBEAFE', color: '#2563EB' },
                    'Güncel': { bg: '#D1FAE5', color: '#059669' },
                    'Bitmiş': { bg: '#E5E7EB', color: '#4B5563' }
                };
                return renkler[durum] || { bg: '#F3F4F6', color: '#6B7280' };
            };

            const getHakedisDurumRenk = (durum) => {
                const renkler = { 
                    'Hakediş ödemesi hazırlanıyor': { bg: '#FEF3C7', color: '#D97706' }, 
                    'Ödeme bekliyor': { bg: '#DBEAFE', color: '#2563EB' }, 
                    'Belediyeden çıkmış': { bg: '#E0E7FF', color: '#4338CA' }, 
                    'Ödenmiş': { bg: '#D1FAE5', color: '#059669' } 
                };
                return renkler[durum] || { bg: '#F3F4F6', color: '#6B7280' };
            };

            return (
                <div className="modal-overlay" onClick={onKapat}>
                    <div className="modal-content" style={{maxWidth: '1400px', maxHeight: '95vh'}} onClick={e => e.stopPropagation()}>
                        <div className="modal-header" style={{background: `linear-gradient(135deg, ${firmaRenk}15 0%, ${firmaRenk}05 100%)`}}>
                            <h2 className="modal-baslik" style={{color: firmaRenk}}>
                                <span style={{fontSize: '24px', width: '24px', height: '24px', display: 'inline-flex', alignItems: 'center', justifyContent: 'center'}}>🏢</span> 
                                Yapı Kayıt Kartı - {proje.ybifNo}
                            </h2>
                            <button onClick={onKapat} className="modal-kapat">{Icons.close}</button>
                        </div>
                        
                        <div className="modal-body" style={{padding: '24px'}}>
                            {/* Proje Bilgileri */}
                            <div style={{
                                background: 'white',
                                borderRadius: '16px',
                                padding: '24px',
                                marginBottom: '24px',
                                border: `2px solid ${firmaRenk}20`,
                                boxShadow: 'var(--shadow-md)'
                            }}>
                                <h3 style={{
                                    fontSize: '18px',
                                    fontWeight: '700',
                                    color: firmaRenk,
                                    marginBottom: '20px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px'
                                }}>
                                    <span style={{fontSize: '20px'}}>📋</span> Proje Bilgileri
                                </h3>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
                                    gap: '16px'
                                }}>
                                    <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '8px'}}>
                                        <div style={{fontSize: '12px', color: 'var(--gray-500)', marginBottom: '4px'}}>Proje Adı</div>
                                        <div style={{fontSize: '15px', fontWeight: '600', color: 'var(--gray-900)'}}>{proje.projeAdi}</div>
                                    </div>
                                    <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '8px'}}>
                                        <div style={{fontSize: '12px', color: 'var(--gray-500)', marginBottom: '4px'}}>İlçe</div>
                                        <div style={{fontSize: '15px', fontWeight: '600', color: 'var(--gray-900)'}}>{proje.ilce}</div>
                                    </div>
                                    <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '8px'}}>
                                        <div style={{fontSize: '12px', color: 'var(--gray-500)', marginBottom: '4px'}}>İş Durumu</div>
                                        <span className="badge" style={{ 
                                            backgroundColor: getDurumRenk(proje.isDurumu).bg, 
                                            color: getDurumRenk(proje.isDurumu).color 
                                        }}>
                                            {proje.isDurumu}
                                        </span>
                                    </div>
                                    <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '8px'}}>
                                        <div style={{fontSize: '12px', color: 'var(--gray-500)', marginBottom: '4px'}}>Yapı Grubu</div>
                                        <div style={{fontSize: '15px', fontWeight: '600', color: 'var(--gray-900)'}}>{proje.yapiGrubu}</div>
                                    </div>
                                    <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '8px'}}>
                                        <div style={{fontSize: '12px', color: 'var(--gray-500)', marginBottom: '4px'}}>Metrekare</div>
                                        <div style={{fontSize: '15px', fontWeight: '600', color: 'var(--gray-900)'}}>{formatSayi(proje.metrekare)} m²</div>
                                    </div>
                                    <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '8px'}}>
                                        <div style={{fontSize: '12px', color: 'var(--gray-500)', marginBottom: '4px'}}>Güncel Metrekare</div>
                                        <div style={{fontSize: '15px', fontWeight: '600', color: 'var(--gray-900)'}}>{formatSayi(proje.guncelMetrekare || proje.metrekare)} m²</div>
                                    </div>
                                    <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '8px'}}>
                                        <div style={{fontSize: '12px', color: 'var(--gray-500)', marginBottom: '4px'}}>Kat Adedi</div>
                                        <div style={{fontSize: '15px', fontWeight: '600', color: 'var(--gray-900)'}}>{proje.katAdedi}</div>
                                    </div>
                                    <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '8px'}}>
                                        <div style={{fontSize: '12px', color: 'var(--gray-500)', marginBottom: '4px'}}>Birim Fiyat</div>
                                        <div style={{fontSize: '15px', fontWeight: '600', color: 'var(--gray-900)'}}>{formatPara(proje.birimFiyat)}</div>
                                    </div>
                                    <div style={{padding: '12px', background: 'linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%)', borderRadius: '8px', border: '1px solid #A7F3D0'}}>
                                        <div style={{fontSize: '12px', color: '#047857', marginBottom: '4px'}}>Hizmet Bedeli</div>
                                        <div style={{fontSize: '16px', fontWeight: '700', color: '#059669'}}>{formatPara(proje.hizmetBedeli)}</div>
                                    </div>
                                    <div style={{padding: '12px', background: 'linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%)', borderRadius: '8px', border: '1px solid #BFDBFE'}}>
                                        <div style={{fontSize: '12px', color: '#1E40AF', marginBottom: '4px'}}>Sözleşme Bedeli</div>
                                        <div style={{fontSize: '16px', fontWeight: '700', color: '#2563EB'}}>{formatPara(proje.sozlesmeBedeli)}</div>
                                    </div>
                                    <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '8px'}}>
                                        <div style={{fontSize: '12px', color: 'var(--gray-500)', marginBottom: '4px'}}>Ruhsat Tarihi</div>
                                        <div style={{fontSize: '15px', fontWeight: '600', color: 'var(--gray-900)'}}>{formatTarih(proje.ruhsatTarihi)}</div>
                                    </div>
                                    <div style={{padding: '12px', background: 'var(--gray-50)', borderRadius: '8px'}}>
                                        <div style={{fontSize: '12px', color: 'var(--gray-500)', marginBottom: '4px'}}>Sanayi Bölgesi</div>
                                        <div style={{fontSize: '15px', fontWeight: '600', color: 'var(--gray-900)'}}>{proje.sanayiBolgesi}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Beton Kayıtları */}
                            <div style={{
                                background: 'white',
                                borderRadius: '16px',
                                padding: '24px',
                                marginBottom: '24px',
                                border: '2px solid #E0E7FF',
                                boxShadow: 'var(--shadow-md)'
                            }}>
                                <h3 style={{
                                    fontSize: '18px',
                                    fontWeight: '700',
                                    color: '#4338CA',
                                    marginBottom: '16px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px'
                                }}>
                                    <span style={{fontSize: '20px'}}>🏗️</span> Beton Kayıtları ({projeBetonlari.length})
                                </h3>
                                {projeBetonlari.length > 0 ? (
                                    <div style={{overflowX: 'auto'}}>
                                        <table className="tablo" style={{fontSize: '12px'}}>
                                            <thead>
                                                <tr>
                                                    <th>Beton Kat</th>
                                                    <th>Döküm Tarihi</th>
                                                    <th>Beton Sınıfı</th>
                                                    <th>7 Gün Tarih</th>
                                                    <th>7 Gün Sonuç</th>
                                                    <th>28 Gün Tarih</th>
                                                    <th>28 Gün Sonuç</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {projeBetonlari.map(beton => (
                                                    <tr key={beton.id}>
                                                        <td><strong>{beton.betonKat}</strong></td>
                                                        <td>{formatTarih(beton.dokumTarihi)}</td>
                                                        <td><span className="badge" style={{background: '#E0E7FF', color: '#4338CA', fontSize: '11px'}}>{beton.betonSinifi}</span></td>
                                                        <td>{formatTarih(beton.yediTarih)}</td>
                                                        <td>{beton.yediSonuc || '-'}</td>
                                                        <td>{formatTarih(beton.yirmiSekizTarih)}</td>
                                                        <td style={{ background: beton.yirmiSekizTarih && !beton.yirmiSekizSonuc && new Date() >= new Date(beton.yirmiSekizTarih) ? '#FEE2E2' : 'transparent' }}>
                                                            {beton.yirmiSekizSonuc || '-'}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div style={{textAlign: 'center', padding: '32px', color: 'var(--gray-400)'}}>
                                        Henüz beton kaydı bulunmuyor
                                    </div>
                                )}
                            </div>

                            {/* Hakediş Kayıtları */}
                            <div style={{
                                background: 'white',
                                borderRadius: '16px',
                                padding: '24px',
                                border: '2px solid #D1FAE5',
                                boxShadow: 'var(--shadow-md)'
                            }}>
                                <h3 style={{
                                    fontSize: '18px',
                                    fontWeight: '700',
                                    color: '#059669',
                                    marginBottom: '16px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px'
                                }}>
                                    <span style={{fontSize: '20px'}}>💰</span> Hakediş Kayıtları ({projeHakedisleri.length})
                                </h3>
                                {projeHakedisleri.length > 0 ? (
                                    <div style={{overflowX: 'auto'}}>
                                        <table className="tablo" style={{fontSize: '12px'}}>
                                            <thead>
                                                <tr>
                                                    <th>Hakediş No</th>
                                                    <th>Tarih</th>
                                                    <th>Küm. %</th>
                                                    <th>Net %</th>
                                                    <th>Durum</th>
                                                    <th>Hakediş Tutarı</th>
                                                    <th>Kesinti</th>
                                                    <th>Fatura Bedeli</th>
                                                    <th>KDV'li Yatan</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {projeHakedisleri.map(hakedis => (
                                                    <tr key={hakedis.id}>
                                                        <td><strong>{hakedis.hakedisNo}</strong></td>
                                                        <td>{formatTarih(hakedis.tarih)}</td>
                                                        <td>%{hakedis.kumulatifYuzde}</td>
                                                        <td>%{hakedis.netHakedisYuzdesi?.toFixed(2)}</td>
                                                        <td>
                                                            <span className="badge" style={{ 
                                                                backgroundColor: getHakedisDurumRenk(hakedis.durum).bg, 
                                                                color: getHakedisDurumRenk(hakedis.durum).color,
                                                                fontSize: '10px'
                                                            }}>
                                                                {hakedis.durum}
                                                            </span>
                                                        </td>
                                                        <td>{formatPara(hakedis.hakedisTutari)}</td>
                                                        <td style={{color: '#DC2626'}}>{formatPara(hakedis.kesinti)}</td>
                                                        <td><strong style={{color: '#2563EB'}}>{formatPara(hakedis.faturaBedeli)}</strong></td>
                                                        <td><strong style={{color: '#059669'}}>{formatPara(hakedis.kdvliYatanBedel)}</strong></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div style={{textAlign: 'center', padding: '32px', color: 'var(--gray-400)'}}>
                                        Henüz hakediş kaydı bulunmuyor
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="modal-footer">
                            <button 
                                onClick={() => {
                                    const firma = FIRMA_LISTESI.find(f => f.id === firmaId);
                                    pdfYapiKayitKarti(proje, projeBetonlari, projeHakedisleri, firma.ad);
                                }} 
                                className="btn btn-pdf"
                            >
                                {Icons.pdf} PDF Indir
                            </button>
                            <button onClick={onKapat} className="btn-kaydet">Kapat</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== BETON SAYFASI ====================
        function BetonSayfasi({ firmaId, betonlar, setBetonlar, projeler, aramaMetni, setAramaMetni, firmaRenk }) {
            const [modalAcik, setModalAcik] = useState(false);
            const [modalTipi, setModalTipi] = useState('ekle');
            const [seciliBeton, setSeciliBeton] = useState(null);

            const filtrelenmisBeton = betonlar.filter(b => b.ybifNo?.toLowerCase().includes(aramaMetni.toLowerCase())).sort((a, b) => {
                const ybifA = a.ybifNo || '';
                const ybifB = b.ybifNo || '';
                return ybifB.localeCompare(ybifA, undefined, { numeric: true });
            });

            const handleEkle = () => { setModalTipi('ekle'); setSeciliBeton(null); setModalAcik(true); };
            const handleGuncelle = () => {
                if (!seciliBeton) { alert('Lütfen güncellemek için bir kayıt seçin'); return; }
                setModalTipi('guncelle'); setModalAcik(true);
            };
            const handleSil = () => {
                if (!seciliBeton) { alert('Lütfen silmek için bir kayıt seçin'); return; }
                if (confirm('Bu beton kaydını silmek istediğinize emin misiniz?')) {
                    setBetonlar(betonlar.filter(b => b.id !== seciliBeton.id)); setSeciliBeton(null);
                }
            };
            const handleKaydet = (betonVerisi) => {
                if (modalTipi === 'ekle') setBetonlar([...betonlar, { ...betonVerisi, id: Date.now() }]);
                else setBetonlar(betonlar.map(b => b.id === seciliBeton.id ? {...betonVerisi, id: seciliBeton.id} : b));
                setModalAcik(false); setSeciliBeton(null);
            };

            const handleExcelAktar = () => {
                const firma = FIRMA_LISTESI.find(f => f.id === firmaId);
                excelAktarBetonlar(filtrelenmisBeton, firma.ad);
            };

            return (
                <div>
                    <div className="aksiyon-bar">
                        <div className="buton-container">
                            <button onClick={handleEkle} className="btn btn-ekle">{Icons.plus} Yeni Kayıt</button>
                            <button onClick={handleGuncelle} className="btn btn-guncelle">{Icons.edit} Düzenle</button>
                            <button onClick={handleSil} className="btn btn-sil">{Icons.trash} Sil</button>
                            <button onClick={handleExcelAktar} className="btn btn-excel">{Icons.excel} Excel'e Aktar</button>
                        </div>
                        <div className="arama-container">
                            <span className="arama-icon">{Icons.search}</span>
                            <input type="text" placeholder="YBİF No ile ara..." value={aramaMetni} onChange={(e) => setAramaMetni(e.target.value)} className="arama-input" />
                        </div>
                    </div>

                    <div className="tablo-container">
                        <div className="tablo-scroll" style={{maxHeight: 'calc(100vh - 250px)'}}>
                            <table className="tablo">
                                <thead>
                                    <tr>
                                        {['YBİF No', 'Proje Adı', 'Kat Adedi', 'Beton Kat', 'Döküm Tarihi', 'Beton Sınıfı', '7 Gün Tarih', '7 Gün Sonuç', '28 Gün Tarih', '28 Gün Sonuç'].map(h => (
                                            <th key={h}>{h}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {filtrelenmisBeton.map(beton => (
                                        <tr key={beton.id} onClick={() => setSeciliBeton(beton)} onDoubleClick={() => { setSeciliBeton(beton); setModalTipi('guncelle'); setModalAcik(true); }}
                                            className={seciliBeton?.id === beton.id ? 'selected' : ''}>
                                            <td><strong>{beton.ybifNo}</strong></td>
                                            <td>{beton.projeAdi}</td>
                                            <td>{beton.katAdedi}</td>
                                            <td>{beton.betonKat}</td>
                                            <td>{formatTarih(beton.dokumTarihi)}</td>
                                            <td><span className="badge" style={{background: '#E0E7FF', color: '#4338CA'}}>{beton.betonSinifi}</span></td>
                                            <td>{formatTarih(beton.yediTarih)}</td>
                                            <td>{beton.yediSonuc || '-'}</td>
                                            <td>{formatTarih(beton.yirmiSekizTarih)}</td>
                                            <td style={{ background: beton.yirmiSekizTarih && !beton.yirmiSekizSonuc && new Date() >= new Date(beton.yirmiSekizTarih) ? '#FEE2E2' : 'transparent' }}>
                                                {beton.yirmiSekizSonuc || '-'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {filtrelenmisBeton.length === 0 && (
                                <div className="bos-veri">
                                    {Icons.empty}
                                    <div>{aramaMetni ? 'Kayıt bulunamadı' : 'Henüz beton kaydı eklenmedi'}</div>
                                </div>
                            )}
                        </div>
                    </div>

                    {modalAcik && <BetonModal beton={modalTipi === 'guncelle' ? seciliBeton : null} projeler={projeler} onKaydet={handleKaydet} onKapat={() => { setModalAcik(false); setSeciliBeton(null); }} baslik={modalTipi === 'ekle' ? 'Yeni Beton Kaydı' : 'Beton Kaydı Düzenle'} />}
                </div>
            );
        }

        // ==================== BETON MODAL ====================
        function BetonModal({ beton, projeler, onKaydet, onKapat, baslik }) {
            const [form, setForm] = useState({
                ybifNo: beton?.ybifNo || '', projeAdi: beton?.projeAdi || '', katAdedi: beton?.katAdedi || '',
                betonKat: beton?.betonKat || '', dokumTarihi: beton?.dokumTarihi || '', betonSinifi: beton?.betonSinifi || 'C25',
                yediTarih: beton?.yediTarih || '', yediSonuc: beton?.yediSonuc || '',
                yirmiSekizTarih: beton?.yirmiSekizTarih || '', yirmiSekizSonuc: beton?.yirmiSekizSonuc || '',
            });

            useEffect(() => {
                const proje = projeler.find(p => p.ybifNo === form.ybifNo);
                if (proje) setForm(prev => ({ ...prev, projeAdi: proje.projeAdi, katAdedi: proje.katAdedi }));
            }, [form.ybifNo, projeler]);

            useEffect(() => {
                if (form.dokumTarihi) {
                    const dokum = new Date(form.dokumTarihi);
                    const yedi = new Date(dokum); yedi.setDate(yedi.getDate() + 7);
                    const yirmiSekiz = new Date(dokum); yirmiSekiz.setDate(yirmiSekiz.getDate() + 28);
                    setForm(prev => ({ ...prev, yediTarih: yedi.toISOString().split('T')[0], yirmiSekizTarih: yirmiSekiz.toISOString().split('T')[0] }));
                }
            }, [form.dokumTarihi]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!form.ybifNo || !form.betonKat) { alert('YBİF No ve Beton Kat bilgisi zorunludur'); return; }
                onKaydet(form);
            };

            return (
                <div className="modal-overlay" onClick={onKapat}>
                    <div className="modal-content" style={{maxWidth: '700px'}} onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-baslik">{Icons.concrete} {baslik}</h2>
                            <button onClick={onKapat} className="modal-kapat">{Icons.close}</button>
                        </div>
                        <div className="modal-body">
                            <form onSubmit={handleSubmit}>
                                <div className="form-grid form-grid-3">
                                    <div className="form-grup">
                                        <label className="label">YBİF No *</label>
                                        <input type="text" value={form.ybifNo} onChange={e => setForm({...form, ybifNo: e.target.value})} className="input" required />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Proje Adı</label>
                                        <input type="text" value={form.projeAdi} disabled className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Kat Adedi</label>
                                        <input type="text" value={form.katAdedi} disabled className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Beton Kat *</label>
                                        <input type="text" value={form.betonKat} onChange={e => setForm({...form, betonKat: e.target.value})} placeholder="Örn: Temel" className="input" required />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Döküm Tarihi</label>
                                        <input type="date" value={form.dokumTarihi} onChange={e => setForm({...form, dokumTarihi: e.target.value})} className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Beton Sınıfı</label>
                                        <select value={form.betonSinifi} onChange={e => setForm({...form, betonSinifi: e.target.value})} className="select">
                                            {BETON_SINIFLARI.map(s => <option key={s} value={s}>{s}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">7 Gün Tarih</label>
                                        <input type="text" value={formatTarih(form.yediTarih)} disabled className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">7 Gün Sonuç (MPa)</label>
                                        <input type="text" value={form.yediSonuc} onChange={e => setForm({...form, yediSonuc: e.target.value})} placeholder="MPa" className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">28 Gün Tarih</label>
                                        <input type="text" value={formatTarih(form.yirmiSekizTarih)} disabled className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">28 Gün Sonuç (MPa)</label>
                                        <input type="text" value={form.yirmiSekizSonuc} onChange={e => setForm({...form, yirmiSekizSonuc: e.target.value})} placeholder="MPa" className="input" />
                                    </div>
                                </div>
                                <div className="modal-footer" style={{margin: '28px -28px -28px', borderRadius: '0 0 20px 20px'}}>
                                    <button type="button" onClick={onKapat} className="btn-iptal">İptal</button>
                                    <button type="submit" className="btn-kaydet">{beton ? 'Güncelle' : 'Kaydet'}</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== HAKEDİŞ SAYFASI ====================
        function HakedisSayfasi({ firmaId, hakedisler, setHakedisler, projeler, setProjeler, aramaMetni, setAramaMetni, firmaRenk }) {
            const [modalAcik, setModalAcik] = useState(false);
            const [modalTipi, setModalTipi] = useState('ekle');
            const [seciliHakedis, setSeciliHakedis] = useState(null);

            const ozet = {
                hazirlanan: hakedisler.filter(h => h.durum === 'Hakediş ödemesi hazırlanıyor').reduce((t, h) => t + (parseFloat(h.faturaBedeli) || 0), 0),
                bekleyen: hakedisler.filter(h => h.durum === 'Ödeme bekliyor').reduce((t, h) => t + (parseFloat(h.faturaBedeli) || 0), 0),
                belediyedenCikmis: hakedisler.filter(h => h.durum === 'Belediyeden çıkmış').reduce((t, h) => t + (parseFloat(h.faturaBedeli) || 0), 0),
                odenmis: hakedisler.filter(h => h.durum === 'Ödenmiş').reduce((t, h) => t + (parseFloat(h.kdvliYatanBedel) || 0), 0),
            };

            const filtrelenmisHakedis = hakedisler.filter(h => h.ybifNo?.toLowerCase().includes(aramaMetni.toLowerCase())).sort((a, b) => {
                const ybifA = a.ybifNo || '';
                const ybifB = b.ybifNo || '';
                return ybifB.localeCompare(ybifA, undefined, { numeric: true });
            });

            const handleEkle = () => { setModalTipi('ekle'); setSeciliHakedis(null); setModalAcik(true); };
            const handleGuncelle = () => {
                if (!seciliHakedis) { alert('Lütfen güncellemek için bir kayıt seçin'); return; }
                setModalTipi('guncelle'); setModalAcik(true);
            };
            const handleSil = () => {
                if (!seciliHakedis) { alert('Lütfen silmek için bir kayıt seçin'); return; }
                if (confirm('Bu hakediş kaydını silmek istediğinize emin misiniz?')) {
                    setHakedisler(hakedisler.filter(h => h.id !== seciliHakedis.id)); setSeciliHakedis(null);
                }
            };
            const handleKaydet = (hakedisVerisi) => {
                if (modalTipi === 'ekle') {
                    setHakedisler([...hakedisler, { ...hakedisVerisi, id: Date.now() }]);
                    
                    // Sadece "Belediyeden çıkmış" veya "Ödenmiş" durumunda proje güncellenir
                    if (hakedisVerisi.durum === 'Belediyeden çıkmış' || hakedisVerisi.durum === 'Ödenmiş') {
                        const proje = projeler.find(p => p.ybifNo === hakedisVerisi.ybifNo);
                        if (proje) {
                            const guncelHizmetBedeli = Math.max(0, (proje.hizmetBedeli || 0) - (hakedisVerisi.hakedisTutari || 0));
                            const netYuzde = parseFloat(hakedisVerisi.netHakedisYuzdesi) || 0;
                            
                            // DÜZELTME: Her zaman orijinal metrekareyi kullan!
                            const mevcutGuncelMetrekare = proje.guncelMetrekare || proje.metrekare;
                            const orijinalMetrekare = proje.metrekare; // ORİJİNAL metrekare
                            const netMetrekare = orijinalMetrekare * (netYuzde / 100); // Net metrekare
                            const guncelMetrekare = Math.max(0, mevcutGuncelMetrekare - netMetrekare);
                            
                            setProjeler(projeler.map(p => p.ybifNo === hakedisVerisi.ybifNo ? {...p, hizmetBedeli: guncelHizmetBedeli, guncelMetrekare} : p));
                        }
                    }
                } else {
                    // Güncelleme durumunda
                    const eskiHakedis = hakedisler.find(h => h.id === seciliHakedis.id);
                    setHakedisler(hakedisler.map(h => h.id === seciliHakedis.id ? {...hakedisVerisi, id: seciliHakedis.id} : h));
                    
                    // Durum değişikliği kontrolü
                    const proje = projeler.find(p => p.ybifNo === hakedisVerisi.ybifNo);
                    if (proje) {
                        const yeniDurum = hakedisVerisi.durum === 'Belediyeden çıkmış' || hakedisVerisi.durum === 'Ödenmiş';
                        const eskiDurum = eskiHakedis && (eskiHakedis.durum === 'Belediyeden çıkmış' || eskiHakedis.durum === 'Ödenmiş');
                        
                        // Eğer durum "Belediyeden çıkmış" veya "Ödenmiş"e değiştiyse, proje güncelle
                        if (yeniDurum && !eskiDurum) {
                            const guncelHizmetBedeli = Math.max(0, (proje.hizmetBedeli || 0) - (hakedisVerisi.hakedisTutari || 0));
                            const netYuzde = parseFloat(hakedisVerisi.netHakedisYuzdesi) || 0;
                            
                            // DÜZELTME: Her zaman orijinal metrekareyi kullan!
                            const mevcutGuncelMetrekare = proje.guncelMetrekare || proje.metrekare;
                            const orijinalMetrekare = proje.metrekare; // ORİJİNAL metrekare
                            const netMetrekare = orijinalMetrekare * (netYuzde / 100); // Net metrekare
                            const guncelMetrekare = Math.max(0, mevcutGuncelMetrekare - netMetrekare);
                            
                            setProjeler(projeler.map(p => p.ybifNo === hakedisVerisi.ybifNo ? {...p, hizmetBedeli: guncelHizmetBedeli, guncelMetrekare} : p));
                        }
                        // Eğer durum "Belediyeden çıkmış" veya "Ödenmiş"ten çıktıysa, proje geri yükle
                        else if (!yeniDurum && eskiDurum) {
                            const guncelHizmetBedeli = (proje.hizmetBedeli || 0) + (eskiHakedis.hakedisTutari || 0);
                            const netYuzde = parseFloat(eskiHakedis.netHakedisYuzdesi) || 0;
                            
                            // DÜZELTME: Geri yüklerken orijinal metrekareyi kullan!
                            const mevcutGuncelMetrekare = proje.guncelMetrekare || proje.metrekare;
                            const orijinalMetrekare = proje.metrekare; // ORİJİNAL metrekare
                            const netMetrekare = orijinalMetrekare * (netYuzde / 100); // Net metrekare
                            const guncelMetrekare = Math.min(orijinalMetrekare, mevcutGuncelMetrekare + netMetrekare);
                            
                            setProjeler(projeler.map(p => p.ybifNo === hakedisVerisi.ybifNo ? {...p, hizmetBedeli: guncelHizmetBedeli, guncelMetrekare} : p));
                        }
                    }
                }
                setModalAcik(false); setSeciliHakedis(null);
            };

            const handleExcelAktar = () => {
                const firma = FIRMA_LISTESI.find(f => f.id === firmaId);
                excelAktarHakedisler(filtrelenmisHakedis, firma.ad);
            };

            const handleFaturaPDF = () => {
                if (!seciliHakedis) { alert('Lutfen fatura olusturmak icin bir hakedis secin'); return; }
                const proje = projeler.find(p => p.ybifNo === seciliHakedis.ybifNo);
                if (!proje) { alert('Proje bulunamadi'); return; }
                const firma = FIRMA_LISTESI.find(f => f.id === firmaId);
                pdfHakedisFaturasi(seciliHakedis, proje, firma.ad);
            };

            const getDurumRenk = (durum) => {
                const renkler = { 
                    'Hakediş ödemesi hazırlanıyor': { bg: '#FEF3C7', color: '#D97706' }, 
                    'Ödeme bekliyor': { bg: '#DBEAFE', color: '#2563EB' }, 
                    'Belediyeden çıkmış': { bg: '#E0E7FF', color: '#4338CA' }, 
                    'Ödenmiş': { bg: '#D1FAE5', color: '#059669' } 
                };
                return renkler[durum] || { bg: '#F3F4F6', color: '#6B7280' };
            };

            const ozetKartlari = [
                { label: 'Hazırlanan', value: formatPara(ozet.hazirlanan), color: '#D97706', icon: '⏳' },
                { label: 'Bekleyen', value: formatPara(ozet.bekleyen), color: '#2563EB', icon: '📋' },
                { label: 'Belediyeden Çıkmış', value: formatPara(ozet.belediyedenCikmis), color: '#7C3AED', icon: '📤' },
                { label: 'Ödenmiş', value: formatPara(ozet.odenmis), color: '#059669', icon: '✅' },
            ];

            return (
                <div>
                    <div className="ozet-container" style={{gridTemplateColumns: 'repeat(4, 1fr)'}}>
                        {ozetKartlari.map((item, i) => (
                            <div key={i} className="ozet-kart">
                                <div style={{ position: 'absolute', top: 0, left: 0, width: '4px', height: '100%', background: item.color, borderRadius: '16px 0 0 16px' }}></div>
                                <div className="ozet-icon" style={{ background: `${item.color}15`, color: item.color }}>{item.icon}</div>
                                <div className="ozet-baslik">{item.label}</div>
                                <div className="ozet-deger small">{item.value}</div>
                            </div>
                        ))}
                    </div>

                    <div className="aksiyon-bar">
                        <div className="buton-container">
                            <button onClick={handleEkle} className="btn btn-ekle">{Icons.plus} Yeni Hakediş</button>
                            <button onClick={handleGuncelle} className="btn btn-guncelle">{Icons.edit} Düzenle</button>
                            <button onClick={handleSil} className="btn btn-sil">{Icons.trash} Sil</button>
                            <button onClick={handleFaturaPDF} className="btn btn-pdf">{Icons.pdf} Fatura PDF</button>
                            <button onClick={handleExcelAktar} className="btn btn-excel">{Icons.excel} Excel'e Aktar</button>
                        </div>
                        <div className="arama-container">
                            <span className="arama-icon">{Icons.search}</span>
                            <input type="text" placeholder="YBİF No ile ara..." value={aramaMetni} onChange={(e) => setAramaMetni(e.target.value)} className="arama-input" />
                        </div>
                    </div>

                    <div className="tablo-container">
                        <div className="tablo-scroll">
                            <table className="tablo">
                                <thead>
                                    <tr>
                                        {['YBİF No', 'Proje Adı', 'Hakediş No', 'Tarih', 'Küm. %', 'Net %', 'Durum', 'Hakediş Tutarı', 'Kesinti', 'Fatura Bedeli', "KDV'li Yatan"].map(h => (
                                            <th key={h}>{h}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {filtrelenmisHakedis.map(hakedis => (
                                        <tr key={hakedis.id} onClick={() => setSeciliHakedis(hakedis)} onDoubleClick={() => { setSeciliHakedis(hakedis); setModalTipi('guncelle'); setModalAcik(true); }}
                                            className={seciliHakedis?.id === hakedis.id ? 'selected' : ''}>
                                            <td><strong>{hakedis.ybifNo}</strong></td>
                                            <td>{hakedis.projeAdi}</td>
                                            <td>{hakedis.hakedisNo}</td>
                                            <td>{formatTarih(hakedis.tarih)}</td>
                                            <td>%{hakedis.kumulatifYuzde}</td>
                                            <td>%{hakedis.netHakedisYuzdesi?.toFixed(2)}</td>
                                            <td>
                                                <span className="badge" style={{ 
                                                    backgroundColor: getDurumRenk(hakedis.durum).bg, 
                                                    color: getDurumRenk(hakedis.durum).color,
                                                    fontSize: '11px'
                                                }}>
                                                    {hakedis.durum}
                                                </span>
                                            </td>
                                            <td>{formatPara(hakedis.hakedisTutari)}</td>
                                            <td style={{color: '#DC2626'}}>{formatPara(hakedis.kesinti)}</td>
                                            <td><strong style={{color: '#2563EB'}}>{formatPara(hakedis.faturaBedeli)}</strong></td>
                                            <td><strong style={{color: '#059669'}}>{formatPara(hakedis.kdvliYatanBedel)}</strong></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {filtrelenmisHakedis.length === 0 && (
                                <div className="bos-veri">
                                    {Icons.empty}
                                    <div>{aramaMetni ? 'Kayıt bulunamadı' : 'Henüz hakediş kaydı eklenmedi'}</div>
                                </div>
                            )}
                        </div>
                    </div>

                    {modalAcik && <HakedisModal hakedis={modalTipi === 'guncelle' ? seciliHakedis : null} hakedisler={hakedisler} projeler={projeler} onKaydet={handleKaydet} onKapat={() => { setModalAcik(false); setSeciliHakedis(null); }} baslik={modalTipi === 'ekle' ? 'Yeni Hakediş' : 'Hakediş Düzenle'} />}
                </div>
            );
        }

        // ==================== HAKEDİŞ MODAL ====================
        function HakedisModal({ hakedis, hakedisler, projeler, onKaydet, onKapat, baslik }) {
            const [form, setForm] = useState({
                ybifNo: hakedis?.ybifNo || '', projeAdi: hakedis?.projeAdi || '', hakedisNo: hakedis?.hakedisNo || '',
                tarih: hakedis?.tarih || '', sonHakedisYuzdesi: hakedis?.sonHakedisYuzdesi || 0,
                kumulatifYuzde: hakedis?.kumulatifYuzde || '', netHakedisYuzdesi: hakedis?.netHakedisYuzdesi || 0,
                durum: hakedis?.durum || 'Hakediş ödemesi hazırlanıyor', hakedisTutari: hakedis?.hakedisTutari || 0,
                kesinti: hakedis?.kesinti || 0, kesintiliBedel: hakedis?.kesintiliBedel || 0, tevkifat: hakedis?.tevkifat || 'Hayır',
                kdv: hakedis?.kdv || 0, tevkifatliKdv: hakedis?.tevkifatliKdv || 0, faturaBedeli: hakedis?.faturaBedeli || 0, kdvliYatanBedel: hakedis?.kdvliYatanBedel || 0,
                sozlesmeBedeli: hakedis?.sozlesmeBedeli || 0,
            });

            useEffect(() => {
                const proje = projeler.find(p => p.ybifNo === form.ybifNo);
                if (proje) {
                    const projeHakedisleri = hakedisler.filter(h => h.ybifNo === form.ybifNo && h.id !== hakedis?.id);
                    const sonHakedis = projeHakedisleri.length > 0 ? Math.max(...projeHakedisleri.map(h => parseFloat(h.kumulatifYuzde) || 0)) : 0;
                    setForm(prev => ({ ...prev, projeAdi: proje.projeAdi, sozlesmeBedeli: proje.sozlesmeBedeli, sonHakedisYuzdesi: sonHakedis }));
                }
            }, [form.ybifNo, projeler, hakedisler]);

            useEffect(() => {
                const kumulatif = parseFloat(form.kumulatifYuzde) || 0;
                const sonYuzde = parseFloat(form.sonHakedisYuzdesi) || 0;
                const netYuzde = kumulatif - sonYuzde;
                const sozlesmeBedeli = parseFloat(form.sozlesmeBedeli) || 0;
                const hakedisTutari = sozlesmeBedeli * (netYuzde / 100);
                const kesinti = hakedisTutari * 0.06;
                const kesintiliBedel = hakedisTutari - kesinti;
                let kdv, faturaBedeli, kdvliYatanBedel, tevkifatliKdv = 0;
                const toplamKdv = hakedisTutari * 0.20;
                
                if (form.tevkifat === 'Evet') {
                    // Tevkifat varsa: KDV'nin %90'ı kesilir (tevkifat), %10'u yansıtılır
                    tevkifatliKdv = toplamKdv * 0.90;  // Kesilir (devlete ödenir)
                    const yansitilanKdv = toplamKdv * 0.10;  // Yansıtılır/müşteriye ödenir
                    kdv = toplamKdv;  // Toplam KDV (bilgi için)
                    faturaBedeli = hakedisTutari + yansitilanKdv;  // Hakediş + KDV×%10
                    kdvliYatanBedel = kesintiliBedel + yansitilanKdv;  // Sadece %10 ödenir
                } else {
                    kdv = toplamKdv;
                    faturaBedeli = hakedisTutari + kdv;
                    kdvliYatanBedel = kesintiliBedel + kdv;
                }
                setForm(prev => ({ ...prev, netHakedisYuzdesi: netYuzde, hakedisTutari, kesinti, kesintiliBedel, kdv, tevkifatliKdv, faturaBedeli, kdvliYatanBedel }));
            }, [form.kumulatifYuzde, form.sonHakedisYuzdesi, form.sozlesmeBedeli, form.tevkifat]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!form.ybifNo || !form.hakedisNo) { alert('YBİF No ve Hakediş No zorunludur'); return; }
                onKaydet(form);
            };

            return (
                <div className="modal-overlay" onClick={onKapat}>
                    <div className="modal-content" style={{maxWidth: '900px'}} onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-baslik">{Icons.money} {baslik}</h2>
                            <button onClick={onKapat} className="modal-kapat">{Icons.close}</button>
                        </div>
                        <div className="modal-body">
                            <form onSubmit={handleSubmit}>
                                <div className="form-grid">
                                    <div className="form-grup">
                                        <label className="label">YBİF No *</label>
                                        <input type="text" value={form.ybifNo} onChange={e => setForm({...form, ybifNo: e.target.value})} className="input" required />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Proje Adı</label>
                                        <input type="text" value={form.projeAdi} disabled className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Hakediş No *</label>
                                        <input type="text" value={form.hakedisNo} onChange={e => setForm({...form, hakedisNo: e.target.value})} className="input" required />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Hakediş Tarihi</label>
                                        <input type="date" value={form.tarih} onChange={e => setForm({...form, tarih: e.target.value})} className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Son Hakediş %</label>
                                        <input type="text" value={`%${form.sonHakedisYuzdesi}`} disabled className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Kümülatif %</label>
                                        <input type="number" value={form.kumulatifYuzde} onChange={e => setForm({...form, kumulatifYuzde: e.target.value})} className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Net Hakediş %</label>
                                        <input type="text" value={`%${form.netHakedisYuzdesi.toFixed(2)}`} disabled className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Hakediş Durumu</label>
                                        <select value={form.durum} onChange={e => setForm({...form, durum: e.target.value})} className="select">
                                            {HAKEDIS_DURUMLARI.map(d => <option key={d} value={d}>{d}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Sözleşme Bedeli</label>
                                        <input type="text" value={formatPara(form.sozlesmeBedeli)} disabled className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Hakediş Tutarı</label>
                                        <input type="text" value={formatPara(form.hakedisTutari)} disabled className="input success" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Kesinti %6</label>
                                        <input type="text" value={formatPara(form.kesinti)} disabled className="input warning" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Kesintili Bedel</label>
                                        <input type="text" value={formatPara(form.kesintiliBedel)} disabled className="input" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">Tevkifat</label>
                                        <select value={form.tevkifat} onChange={e => setForm({...form, tevkifat: e.target.value})} className="select">
                                            <option value="Hayır">Hayır</option>
                                            <option value="Evet">Evet</option>
                                        </select>
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">KDV (%20) - Toplam</label>
                                        <input type="text" value={formatPara(form.kdv)} disabled className="input" />
                                    </div>
                                    {form.tevkifat === 'Evet' && (
                                        <div className="form-grup">
                                            <label className="label">Tevkifatlı KDV (%90) - Kesilir</label>
                                            <input type="text" value={formatPara(form.tevkifatliKdv)} disabled className="input warning" />
                                        </div>
                                    )}
                                    <div className="form-grup">
                                        <label className="label">{form.tevkifat === 'Evet' ? 'Fatura Bedeli (Hakediş + KDV×%10)' : 'Fatura Bedeli'}</label>
                                        <input type="text" value={formatPara(form.faturaBedeli)} disabled className="input info" />
                                    </div>
                                    <div className="form-grup">
                                        <label className="label">{form.tevkifat === 'Evet' ? "KDV'li Yatan (Kesintili + KDV×%10)" : "KDV'li Yatan Bedel"}</label>
                                        <input type="text" value={formatPara(form.kdvliYatanBedel)} disabled className="input success" />
                                    </div>
                                </div>
                                <div className="modal-footer" style={{margin: '28px -28px -28px', borderRadius: '0 0 20px 20px'}}>
                                    <button type="button" onClick={onKapat} className="btn-iptal">İptal</button>
                                    <button type="submit" className="btn-kaydet">{hakedis ? 'Güncelle' : 'Kaydet'}</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // Uygulamayı başlat
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
